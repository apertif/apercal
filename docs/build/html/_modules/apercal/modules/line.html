
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>apercal.modules.line &#8212; Apercal 2.5.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apercal 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for apercal.modules.line</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">aipy</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pymp</span>

<span class="kn">from</span> <span class="nn">apercal.modules.base</span> <span class="k">import</span> <span class="n">BaseModule</span>
<span class="kn">from</span> <span class="nn">apercal.libs.calculations</span> <span class="k">import</span> <span class="n">calc_dr_maj</span><span class="p">,</span> <span class="n">calc_theoretical_noise</span><span class="p">,</span> <span class="n">calc_theoretical_noise_threshold</span><span class="p">,</span> \
    <span class="n">calc_dynamic_range_threshold</span><span class="p">,</span> <span class="n">calc_clean_cutoff</span><span class="p">,</span> <span class="n">calc_noise_threshold</span><span class="p">,</span> <span class="n">calc_mask_threshold</span><span class="p">,</span> <span class="n">get_freqstart</span><span class="p">,</span> \
    <span class="n">calc_dr_min</span><span class="p">,</span> <span class="n">calc_line_masklevel</span><span class="p">,</span> <span class="n">calc_miniter</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">setinit</span> <span class="k">as</span> <span class="n">subs_setinit</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">managefiles</span> <span class="k">as</span> <span class="n">subs_managefiles</span>
<span class="kn">from</span> <span class="nn">apercal.subs.param</span> <span class="k">import</span> <span class="n">get_param_def</span>

<span class="kn">from</span> <span class="nn">apercal.libs</span> <span class="k">import</span> <span class="n">lib</span>

<span class="kn">from</span> <span class="nn">apercal.exceptions</span> <span class="k">import</span> <span class="n">ApercalException</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="line"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line">[docs]</a><span class="k">class</span> <span class="nc">line</span><span class="p">(</span><span class="n">BaseModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Line class to do continuum subtraction and prepare data for line imaging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="s1">&#39;LINE&#39;</span>

    <span class="n">line_beams</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">line_first_level_threads</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">line_second_level_threads</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">line_input_channelwidth</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not for config file, will be set to finc in create_subbands</span>
    <span class="n">line_cube_channel_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_cube_channelwidth_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_single_cube_input_channels</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#not to be used in the config file</span>
    <span class="n">line_splitdata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_splitdata_force_chunkbandwidth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_splitdata_chunkbandwidth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_splitdata_channelbandwidth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_channelbinning</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_transfergains</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#revive use to allow skipping alpplication of selfcal solutions</span>
    <span class="n">line_subtract</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_majorcycle_function</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_minorcycle_function</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_minorcycle</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_c0</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_c1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_drinit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_dr0</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_nsigma</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_imsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_cellsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_subtract_mode_uvmodel_minorcycle0_dr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_cube_name</span> <span class="o">=</span> <span class="s1">&#39;HI_image_cube.fits&#39;</span>
    <span class="n">line_image_beam_cube_name</span> <span class="o">=</span> <span class="s1">&#39;HI_beam_cube.fits&#39;</span>
    <span class="n">line_image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_input_channels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_channels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_imsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_cellsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_centre</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_robust</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_clean</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_ratio_limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_c0</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_c1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_nsigma</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_minorcycle0_dr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_dr0</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_restorbeam</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_image_convolbeam</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_always_cleanup</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">line_total_channel_numbers</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#not to be used in config file</span>

    <span class="n">selfcaldir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscaldir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">linedir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">contdir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_beams</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_beams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span><span class="p">))</span>
            
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="line.go"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.go">[docs]</a>    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_level_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">second_level_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the whole continuum subtraction process and line imaging in the following order:</span>
<span class="sd">        transfergains</span>
<span class="sd">        createsubbands</span>
<span class="sd">        subtract</span>
<span class="sd">        image line data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_beams</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Line imaging requested on a beam not in line_beams&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># added miriad main file check</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_starting_conditions</span><span class="p">():</span>

            <span class="c1"># added a try-except to allow for removing all auxiliary files in case line crashes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting LINE IMAGING &quot;</span><span class="p">)</span>

                <span class="c1"># setting the threads</span>
                <span class="k">if</span> <span class="n">first_level_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">first_level_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_first_level_threads</span>
                <span class="k">if</span> <span class="n">second_level_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">second_level_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_second_level_threads</span>

                <span class="c1"># build in check on number of threads to prevent excessive demands? (here?)</span>
                <span class="n">original_nested</span> <span class="o">=</span> <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span>
                <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_level_threads</span><span class="p">,</span> <span class="n">second_level_threads</span><span class="p">]</span>
                <span class="n">nthreads</span> <span class="o">=</span> <span class="n">first_level_threads</span> <span class="o">*</span> <span class="n">second_level_threads</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfergains</span><span class="p">(</span><span class="n">nthreads</span><span class="p">)</span>  <span class="c1"># first step after copy of crosscal data</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Function transfergains done &quot;</span><span class="p">)</span>

                <span class="c1"># now go throught the requested image cubes</span>
                <span class="k">for</span> <span class="n">cube_counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">)):</span>

                    <span class="c1"># catch in case line fails on one of the cubes, but make sure it continues with the next cube</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># set the channelbandwidth for splitting for a given cube from the list</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_channelbandwidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="p">]</span>
                        <span class="c1"># if it is the first cube, create the subbands</span>
                        <span class="k">if</span> <span class="n">cube_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">createsubbands</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>  <span class="c1"># create subbands for the first subband</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Function createsubbands done for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                            <span class="c1"># run continuum subtraction only when channel width changes</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>  <span class="c1"># subtract continuum if required</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;(LINE) Function subtract done for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>    
                        <span class="c1"># create the subbands again only if the channel width changes</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">createsubbands</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>  <span class="c1"># create subbands if required</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;(LINE) Function createsubbands done for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                            <span class="c1"># run continuum subtraction only when channel width changes</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>  <span class="c1"># subtract continuum if required</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;(LINE) Function subtract done for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Chunks already exists. Function createsubbands is not executed for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;(LINE) Function subtract not called for cube </span><span class="si">{0}</span><span class="s2"> as it was already called.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>

                        <span class="c1"># set the start and end channel for imaging</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_single_cube_input_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channel_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="p">]</span>
                        <span class="c1"># run imaging</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">image_line</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;(LINE) Failed to create line cube </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    
                    <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">original_nested</span>

                    <span class="c1"># clean up everything in the end</span>
                    <span class="k">if</span> <span class="n">cube_counter</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">clean_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># clean up only the cube directory if the channel width does not change</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_cube_channelwidth_list</span><span class="p">[</span><span class="n">cube_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">clean_level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="c1"># if the channel width changes clean up all except for the mir file</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">clean_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># rename image cube</span>
                    <span class="n">cube_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_cube_name</span>
                    <span class="n">new_cube_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_image_cube_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/HI_image_cube.fits&#39;</span><span class="p">):</span>
                        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="n">new_cube_name</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="n">cube_name</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;(LINE) no image cube made for subband </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">)</span> <span class="p">)</span>

                    <span class="c1"># rename beam cube</span>
                    <span class="n">beam_cube_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_beam_cube_name</span>
                    <span class="n">new_beam_cube_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_image_beam_cube_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/HI_beam_cube.fits&#39;</span><span class="p">):</span>
                        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="n">new_beam_cube_name</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="n">beam_cube_name</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;(LINE) no beam cube made for subband </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;(LINE) module image_line done for cube </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_counter</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LINE IMAGING failed&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_always_cleanup</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All auxiliary files are being deleted&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">clean_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished LINE IMAGING&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;LINE IMAGING failed&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.check_starting_conditions"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.check_starting_conditions">[docs]</a>    <span class="k">def</span> <span class="nf">check_starting_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the miriad file from convert exists.</span>

<span class="sd">        If it does not exists, none of the subsequent tasks in go need to be executed.</span>
<span class="sd">        This seems necessary as not all the tasks do this check and they do not have</span>
<span class="sd">        to. A single task is enough.</span>

<span class="sd">        Not sure if it is necessary to add all the param variables from selfcal</span>
<span class="sd">        and set them False if the check fails. For now, just use the main one</span>

<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            (bool): True if file is found, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking starting conditions for LINE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="c1"># initial setup</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># path to converted miriad file</span>
        <span class="n">mir_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscaldir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="n">all_good</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># check that the file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mir_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Did not find main miriad file in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">mir_file</span><span class="p">))</span>
            <span class="n">all_good</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># check the continuum file</span>
        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;continuum_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">continuumtargetbeamsmfstatus</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_mf_status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">continuumtargetbeamsmfstatus</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Continuum imaging was not successful&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">all_good</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># check that selfcal worked</span>
        <span class="n">sbeam</span> <span class="o">=</span> <span class="s1">&#39;selfcal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">selfcaltargetbeamsphasestatus</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_phase_status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">selfcaltargetbeamsampstatus</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_amp_status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># check selfcal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selfcaltargetbeamsphasestatus</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">selfcaltargetbeamsampstatus</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Neither phase nor amplitude self-calibration was successful. No polarisation imaging&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">all_good</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">all_good</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking starting conditions for LINE ... Done: All good.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking starting conditions for LINE ... Done: Failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">all_good</span></div>

<div class="viewcode-block" id="line.transfergains"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.transfergains">[docs]</a>    <span class="k">def</span> <span class="nf">transfergains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the crosscal data to the line directory and then, if selfcal</span>
<span class="sd">        has been performed, applies the selfcal phase and amp corrections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Copying of target data into line directory started&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Calibrated uv data file seem to be present already #&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Copying crosscal data to line directory before splitting and averaging #&#39;</span><span class="p">)</span>
            <span class="c1">#                uvaver = lib.miriad(&#39;uvaver&#39;)</span>
            <span class="c1">#                uvaver.vis = self.crosscaldir + &#39;/&#39; + self.target</span>
            <span class="c1">#                uvaver.out = self.linedir + &#39;/&#39; + self.target</span>
            <span class="c1">#                uvaver.go()</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                      <span class="n">file_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) crosscal data copied to line directory #&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_transfergains</span><span class="p">:</span>
                <span class="c1"># get status of phase and amplitude selfcal</span>
                <span class="n">sbeam</span> <span class="o">=</span> <span class="s1">&#39;selfcal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">selfcaltargetbeamsphasestatus</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">sbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_phase_status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">selfcaltargetbeamsampstatus</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">sbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_amp_status&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="c1"># apply phase selfcal solutions if these exist</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selfcaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;/gains&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">selfcaltargetbeamsphasestatus</span><span class="p">:</span>
                    <span class="n">gpcopy</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;gpcopy&#39;</span><span class="p">)</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selfcaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Copying phase corrections from selfcal to line data #&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;(LINE) phase selfcal data not found #&#39;</span><span class="p">)</span>
                <span class="c1"># amp selfcal corrections applied</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Selfcal phase solutions applied to target data #&#39;</span><span class="p">)</span>
                <span class="c1"># apply amp selfcal solutions if these exist</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selfcaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.mir&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_amp.mir&#39;</span> <span class="o">+</span> <span class="s1">&#39;/gains&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">selfcaltargetbeamsampstatus</span><span class="p">:</span>
                    <span class="n">gpcopy</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;gpcopy&#39;</span><span class="p">)</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selfcaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.mir&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_amp.mir&#39;</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
                    <span class="n">gpcopy</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Copying amp corrections from selfcal to line data #&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;(LINE) amp selfcal was not successful. Using only phase selfcal. #&#39;</span><span class="p">)</span>
                <span class="c1"># amp selfcal corrections applied</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Selfcal amp solutions applied to target data #&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) No selfcal solutions applied to target data #&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.createsubbands"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.createsubbands">[docs]</a>    <span class="k">def</span> <span class="nf">createsubbands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies calibrator corrections to data, splits the data into chunks in frequency and bins it to the given</span>
<span class="sd">        frequency resolution for the self-calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata</span><span class="p">:</span>
            <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Splitting of target data into individual frequency chunks started&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">uv</span> <span class="o">=</span> <span class="n">aipy</span><span class="o">.</span><span class="n">miriad</span><span class="o">.</span><span class="n">UV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="s1">&#39; (LINE) No data in your line directory!&#39;</span><span class="p">)</span>
            <span class="n">numchan</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[</span><span class="s1">&#39;nschan&#39;</span><span class="p">]</span>  <span class="c1"># Number of channels</span>
            <span class="n">finc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="s1">&#39;sdf&#39;</span><span class="p">])</span>  <span class="c1"># Frequency increment for each channel</span>
            
            <span class="c1"># keep the increment as attribute of the object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_input_channelwidth</span> <span class="o">=</span> <span class="n">finc</span>
            
            <span class="n">subband_bw</span> <span class="o">=</span> <span class="n">numchan</span> <span class="o">*</span> <span class="n">finc</span>  <span class="c1"># Bandwidth of the full band</span>
            <span class="n">subband_chunks</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">subband_bw</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_chunkbandwidth</span><span class="p">)</span>
            <span class="c1"># Round to the closest power of 2 for frequency chunks with the same bandwidth over the frequency</span>
            <span class="c1"># range of a subband</span>
            <span class="n">subband_chunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">subband_chunks</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">subband_chunks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">subband_chunks</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># some more logging messages for information</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_total_channel_numbers</span> <span class="o">=</span> <span class="n">numchan</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Number of channels found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numchan</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Frequency increment found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Total bandwidth: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subband_bw</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Calculated number of chunks based on input chunkbandwidth to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subband_chunks</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_force_chunkbandwidth</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Forcing chunkbandwdith to be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_chunkbandwidth</span><span class="p">))</span>
                <span class="n">chunkbandwdith</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_chunkbandwidth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunkbandwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">numchan</span> <span class="o">/</span> <span class="n">subband_chunks</span><span class="p">)</span> <span class="o">*</span> <span class="n">finc</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Adjusting chunk size to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">chunkbandwidth</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; GHz for regular gridding of the data chunks over frequency&#39;</span><span class="p">)</span>
            <span class="c1"># start splitting the data</span>
            <span class="n">base_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">original_nested</span> <span class="o">=</span> <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span>
            <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">p0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">subband_chunks</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;(LINE) Starting splitting of data chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                    <span class="c1"># new:</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="n">base_counter</span> <span class="o">+</span> <span class="n">chunk</span>
                    <span class="n">binchan</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_channelbandwidth</span> <span class="o">/</span> <span class="n">finc</span><span class="p">)</span>  <span class="c1"># Number of channels per frequency bin</span>
                    <span class="n">chan_per_chunk</span> <span class="o">=</span> <span class="n">numchan</span> <span class="o">/</span> <span class="n">subband_chunks</span>
                    <span class="k">if</span> <span class="n">chan_per_chunk</span> <span class="o">%</span> <span class="n">binchan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check if the freqeuncy bin exactly fits</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(Line) Using frequency binning of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">line_splitdata_channelbandwidth</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; for all subbands (threads [&#39;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Increase the frequency bin to keep a regular grid for the chunks</span>
                        <span class="k">while</span> <span class="n">chan_per_chunk</span> <span class="o">%</span> <span class="n">binchan</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">binchan</span> <span class="o">=</span> <span class="n">binchan</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Check if the calculated bin is not larger than the subband channel number</span>
                            <span class="k">if</span> <span class="n">chan_per_chunk</span> <span class="o">&gt;=</span> <span class="n">binchan</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Set the frequency bin to the number of channels in the chunk of the subband</span>
                                <span class="n">binchan</span> <span class="o">=</span> <span class="n">chan_per_chunk</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Increasing frequency bin of data chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s1">&#39; to keep bandwidth of chunks equal over the whole bandwidth (threads [&#39;</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) New frequency bin is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">binchan</span> <span class="o">*</span> <span class="n">finc</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s1">&#39; GHz (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chan_per_chunk</span> <span class="o">/</span> <span class="n">binchan</span><span class="p">)</span>  <span class="c1"># Total number of output channels per chunk</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">*</span> <span class="n">chan_per_chunk</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">binchan</span><span class="p">)</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">line_channelbinning</span> <span class="o">=</span> <span class="n">binchan</span>
                    <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mk&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">uvaver</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;uvaver&#39;</span><span class="p">)</span>
                    <span class="n">uvaver</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
                    <span class="n">uvaver</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                        <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mir&#39;</span>
                    <span class="n">uvaver</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s1">&#39;channel,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                    <span class="n">uvaver</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                    <span class="c1"># old:</span>
                    <span class="c1"># counter = counter + 1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Splitting of data chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; done (threads [&#39;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                    <span class="c1"># new:</span>
            <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">original_nested</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Splitting of target data into individual frequency chunks done&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) No splitting of target data in frequency chunks performed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.subtract"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.subtract">[docs]</a>    <span class="k">def</span> <span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Module for subtracting the continuum from the line data. Supports uvlin and uvmodel (using the</span>
<span class="sd">        same model as the one used for the final continuum imaging).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_subtract</span><span class="p">:</span>
            <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_subtract_mode</span> <span class="o">==</span> <span class="s1">&#39;uvlin&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Starting continuum subtraction of individual chunks using uvlin&#39;</span><span class="p">)</span>
                <span class="n">chunks_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">()</span>
                <span class="n">original_nested</span> <span class="o">=</span> <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span>
                <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">p0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks_list</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;(LINE) Starting continuum subtraction of data chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunks_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">uvlin</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;uvlin&#39;</span><span class="p">)</span>
                        <span class="n">uvlin</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;.mir&#39;</span>
                        <span class="n">uvlin</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span>
                        <span class="n">uvlin</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Continuum subtraction using uvlin method for chunk &#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39; done #&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Continuum subtraction using uvlin done!&#39;</span><span class="p">)</span>
<span class="c1">#                pymp.config.nested = original_nested</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_subtract_mode</span> <span class="o">==</span> <span class="s1">&#39;uvmodel&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Starting continuum subtraction of individual chunks using uvmodel&#39;</span><span class="p">)</span>
                <span class="n">chunks_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">()</span>
                <span class="n">original_nested</span> <span class="o">=</span> <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span>
                <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">model_number</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;image_mf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
                        <span class="n">model_number</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;(LINE) found model number &#39;</span> <span class="o">+</span> <span class="n">model_number</span> <span class="o">+</span> <span class="s1">&#39; in continuum subdirectory&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">p0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks_list</span><span class="p">)):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;(LINE) Starting continuum subtraction of data chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunks_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contdir</span> <span class="o">+</span> <span class="s1">&#39;/model_mf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_number</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">uvmodel</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;uvmodel&#39;</span><span class="p">)</span>
                        <span class="n">uvmodel</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;.mir&#39;</span>
                        <span class="n">uvmodel</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/model_mf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_number</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">uvmodel</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;subtract,mfs&#39;</span>
                        <span class="n">uvmodel</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span>
                        <span class="c1"># putting the following into a try-except in case something goes wrong on a specific chunk</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">uvmodel</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;(LINE) Subtracted model from chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span>
                                           <span class="s1">&#39; (thread &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                           <span class="s1">&#39; out of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ... Failed&#39;</span><span class="p">)</span>
                            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span><span class="p">,</span>
                                                      <span class="n">file_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;.mir&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Subtracted model from chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39; (thread &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) #&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Continuum subtraction using uvmodel done!&#39;</span><span class="p">)</span>
<span class="c1">#                pymp.config.nested = original_nested</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="s2">&quot;Subtract set to True, but line_subtract_mode not recognized&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) No continuum subtraction performed&#39;</span><span class="p">)</span>
            <span class="n">chunks_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">p0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks_list</span><span class="p">)):</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunks_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span><span class="p">,</span>
                                      <span class="n">file_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;.mir&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) renamed uv data set for line imaging of chunk &#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39; done #&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.image_line"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.image_line">[docs]</a>    <span class="k">def</span> <span class="nf">image_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces a line cube by imaging each individual channel. Saves the images as well as the beam as a FITS-cube.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># get the number of channels that were averaged</span>
        <span class="n">binchan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_channelbinning</span>
        <span class="c1"># Do not use the following line as it does not account for forced adjustment of the channel width</span>
        <span class="c1">#binchan = round(self.line_splitdata_channelbandwidth / self.line_input_channelwidth)</span>

        <span class="c1"># calculate the output start and end channel based on the inputs and channel averaging</span>
        <span class="n">start_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_single_cube_input_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_single_cube_input_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_start_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_channel</span> <span class="o">/</span> <span class="n">binchan</span><span class="p">)</span>
        <span class="n">output_end_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_channel</span> <span class="o">/</span> <span class="n">binchan</span><span class="p">)</span>

        <span class="c1"># put imaging channels into format used below to avoid changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1">,</span><span class="si">{1:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_start_channel</span><span class="p">,</span><span class="n">output_end_channel</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Channel range of cube before averaging: </span><span class="si">{0:d}</span><span class="s2">,</span><span class="si">{1:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_single_cube_input_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_single_cube_input_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(LINE) Channel range of cube after averaging: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Starting line imaging of dataset #&#39;</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; (LINE) Imaging each individual channel separately #&#39;</span><span class="p">)</span>
            <span class="c1"># old:</span>
            <span class="c1"># channel_counter = 0  # Counter for numbering the channels for the whole dataset</span>
            <span class="n">nchunks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">())</span>
            <span class="c1"># new:</span>
            <span class="n">chunk_channels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of number of channels in each chunk</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">():</span>
                <span class="c1"># new:</span>
                <span class="n">nchannel</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir/visdata&#39;</span><span class="p">):</span>
                    <span class="n">uv</span> <span class="o">=</span> <span class="n">aipy</span><span class="o">.</span><span class="n">miriad</span><span class="o">.</span><span class="n">UV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span><span class="p">)</span>
                    <span class="n">nchannel</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[</span><span class="s1">&#39;nschan&#39;</span><span class="p">]</span>  <span class="c1"># Number of channels in the dataset</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (LINE) Beam </span><span class="si">{0}</span><span class="s2">, Chunk </span><span class="si">{1}</span><span class="s2">: Found </span><span class="si">{2}</span><span class="s2"> channels in chunk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">nchannel</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; (LINE) Beam </span><span class="si">{0}</span><span class="s2">, Chunk </span><span class="si">{1}</span><span class="s2">: No visibility data found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">chunk</span><span class="p">))</span>
                <span class="c1"># nchannel cannot be 0, otherwise the counting below would not properly</span>
                <span class="c1"># Calculating the channel number assumes that all cubes have the same number of channels</span>
                <span class="c1"># This is the current state</span>
                <span class="k">if</span> <span class="n">nchannel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># take the number of channels averaged into account</span>
                    <span class="n">nchannel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_total_channel_numbers</span> <span class="o">/</span> <span class="n">nchunks</span> <span class="o">/</span> <span class="n">binchan</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (LINE) Found 0 number of channels. Calculate the correct number of channels of this chunk to be </span><span class="si">{}</span><span class="s2">. (Assuming equal channel numbers of all chunks)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nchannel</span><span class="p">))</span>
                <span class="n">chunk_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nchannel</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; (LINE) List of number of channels in chunks: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">chunk_channels</span><span class="p">)))</span>
            <span class="c1"># old:</span>
            <span class="c1"># for chunk in self.list_chunks():</span>
            <span class="c1"># new:</span>
            <span class="n">original_nested</span> <span class="o">=</span> <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span>
            <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">threads</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">p1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk_index</span> <span class="ow">in</span> <span class="n">p1</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
<span class="c1">#            import mock</span>
<span class="c1">#            p1 = mock.Mock()</span>
<span class="c1">#            p1.thread_num=1</span>
<span class="c1">#            p1.num_threads=1</span>
<span class="c1">#            for chunk_index in range(nchunks):</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_chunks</span><span class="p">()[</span><span class="n">chunk_index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span><span class="p">):</span>
                        <span class="c1"># old:</span>
                        <span class="c1"># uv = aipy.miriad.UV(self.linedir + &#39;/&#39; + chunk + &#39;/&#39; + chunk + &#39;_line.mir&#39;)</span>
                        <span class="c1"># nchannel = uv[&#39;nschan&#39;]  # Number of channels in the dataset</span>
                        <span class="c1"># new:</span>
                        <span class="n">nchannel</span> <span class="o">=</span> <span class="n">chunk_channels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">chunk</span><span class="p">)]</span>
                        <span class="n">base_channel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">chunk_channels</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">chunk</span><span class="p">)])</span>  <span class="c1"># for chunk = 0 this returns 0, which is what we want</span>
                        <span class="k">with</span> <span class="n">pymp</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">p2</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">p2</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">nchannel</span><span class="p">):</span>
<span class="c1">#                        for channel in range(nchannel):</span>
<span class="c1">#                                p2 = mock.Mock()</span>
<span class="c1">#                                p2.thread_num=1</span>
<span class="c1">#                                p2.num_threads=1</span>
                                <span class="c1"># new:</span>
                                <span class="n">channel_counter</span> <span class="o">=</span> <span class="n">base_channel</span> <span class="o">+</span> <span class="n">channel</span>
                                <span class="k">if</span> <span class="n">channel_counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                                                            <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
                                    <span class="n">invert</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;invert&#39;</span><span class="p">)</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="s1">&#39;_line.mir&#39;</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">imsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_imsize</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_cellsize</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;channel,1,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,1,1&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">stokes</span> <span class="o">=</span> <span class="s1">&#39;ii&#39;</span>
                                    <span class="n">invert</span><span class="o">.</span><span class="n">slop</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_robust</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">invert</span><span class="o">.</span><span class="n">robust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_robust</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_centre</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                        <span class="n">invert</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_centre</span>
                                        <span class="n">invert</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;mfs,double,mosaic,sdb&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">invert</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;mfs,double,sdb&#39;</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">invertcmd</span> <span class="o">=</span> <span class="n">invert</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                        <span class="n">invert_succeeded</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invert crashed&quot;</span><span class="p">)</span>
                                        <span class="n">invertcmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                        <span class="n">invert_succeeded</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">invert_succeeded</span><span class="p">)</span> <span class="ow">or</span> <span class="n">invertcmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                            <span class="s1">&#39;(LINE) 0 visibilities in channel &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;! Skipping channel! (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                <span class="n">p1</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                <span class="n">p2</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                                        <span class="c1"># old:</span>
                                        <span class="c1"># channel_counter = channel_counter + 1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1">#theoretical_noise = invertcmd[11].split(&#39; &#39;)[3] # next line replaces old code</span>
                                        <span class="n">theoretical_noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">invertcmd</span>
                                                                   <span class="k">if</span> <span class="s2">&quot;Theoretical rms noise&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">theoretical_noise_threshold</span> <span class="o">=</span> <span class="n">calc_theoretical_noise_threshold</span><span class="p">(</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">theoretical_noise</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_nsigma</span><span class="p">)</span>
                                        <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_max_min_ratio</span><span class="p">(</span><span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_ratio_limit</span><span class="p">:</span>
                                            <span class="n">imax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_imax</span><span class="p">(</span><span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                                            <span class="n">maxdr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">theoretical_noise_threshold</span><span class="p">))</span>
                                            <span class="n">nminiter</span> <span class="o">=</span> <span class="n">calc_miniter</span><span class="p">(</span><span class="n">maxdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_dr0</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">nminiter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                                <span class="n">nminiter</span> <span class="o">=</span> <span class="mi">0</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                                <span class="s1">&#39;(LINE) nmimiter negative for ch &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span>
                                                        <span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, set to 0 to avoid crash&#39;</span><span class="p">)</span>
                                            <span class="n">imclean</span><span class="p">,</span> <span class="n">masklevels</span> <span class="o">=</span> <span class="n">calc_line_masklevel</span><span class="p">(</span><span class="n">nminiter</span><span class="p">,</span>
                                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">line_image_dr0</span><span class="p">,</span> <span class="n">maxdr</span><span class="p">,</span>
                                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">line_image_minorcycle0_dr</span><span class="p">,</span>
                                                                                        <span class="n">imax</span><span class="p">)</span>

                                            <span class="k">if</span> <span class="n">imclean</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_clean</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Emission found in channel &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. Cleaning! (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">p1</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">p2</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                                                <span class="k">for</span> <span class="n">minc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                                                        <span class="n">nminiter</span><span class="p">):</span>  <span class="c1"># Iterate over the minor imaging cycles and masking</span>
                                                    <span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">masklevels</span><span class="p">[</span><span class="n">minc</span><span class="p">]</span>
                                                    <span class="k">if</span> <span class="n">minc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                        <span class="n">maths</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;maths&#39;</span><span class="p">)</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;mask_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&quot;&#39;</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;.gt.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mask_threshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                                        <span class="n">clean_cutoff</span> <span class="o">=</span> <span class="n">calc_clean_cutoff</span><span class="p">(</span><span class="n">mask_threshold</span><span class="p">,</span>
                                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">line_image_c1</span><span class="p">)</span>
                                                        <span class="n">clean</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span>
                                                            <span class="s1">&#39;clean&#39;</span><span class="p">)</span>  <span class="c1"># Clean the image down to the calculated threshold</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;model_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">clean_cutoff</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">niters</span> <span class="o">=</span> <span class="mi">100000</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;mask(mask_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                                    <span class="k">else</span><span class="p">:</span>
                                                        <span class="n">maths</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;maths&#39;</span><span class="p">)</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;mask_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&quot;&#39;</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;.gt.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">mask_threshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                                                        <span class="n">maths</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                                        <span class="n">clean_cutoff</span> <span class="o">=</span> <span class="n">calc_clean_cutoff</span><span class="p">(</span><span class="n">mask_threshold</span><span class="p">,</span>
                                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">line_image_c1</span><span class="p">)</span>
                                                        <span class="n">clean</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">)</span>
                                                        <span class="c1"># Clean the image down to the calculated threshold</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;model_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;model_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">clean_cutoff</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">niters</span> <span class="o">=</span> <span class="mi">100000</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s1">&#39;mask(mask_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                                                        <span class="n">clean</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                                    <span class="n">restor</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;restor&#39;</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;model_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                        <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                        <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;clean&#39;</span>
                                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_restorbeam</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                                        <span class="n">beam_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_restorbeam</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                                        <span class="n">restor</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">beam_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                            <span class="n">beam_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                        <span class="n">restor</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">beam_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                    <span class="k">else</span><span class="p">:</span>
                                                        <span class="k">pass</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>  <span class="c1"># Create the cleaned image</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;residual&#39;</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;residual_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                        <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                    <span class="n">restor</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>  <span class="c1"># Create the residual image</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="c1"># Do one iteration of clean to create a model map for usage with restor</span>
                                                <span class="c1"># to give the beam size.</span>
                                                <span class="n">clean</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">)</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;model_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">niters</span> <span class="o">=</span> <span class="mi">1</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mf">0.0000001</span>
                                                <span class="n">clean</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;&quot;boxes(1,1,2,2)&quot;&#39;</span>
<span class="c1">#                                                clean.go()</span>
<span class="c1">#                                                JMH:   comment this out so no clean is run</span>
                                                <span class="n">restor</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;restor&#39;</span><span class="p">)</span>
                                                <span class="n">restor</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;model_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">restor</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">restor</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;map_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">restor</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;image_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">restor</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;clean&#39;</span>
<span class="c1">#                                                restor.go()</span>
<span class="c1">#                                                JMH:   comment this out so no restor is run</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_convolbeam</span><span class="p">:</span>
                                                <span class="n">convol</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;convol&#39;</span><span class="p">)</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">beam_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_convolbeam</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">beam_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">beam_parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">beam_parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;convol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;final&#39;</span>
                                                <span class="n">convol</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                                <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span>
                                                            <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
                                                            <span class="n">file_</span><span class="o">=</span><span class="s1">&#39;convol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                                            <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">minc</span> <span class="o">=</span> <span class="mi">0</span>
                                            <span class="c1"># Do one iteration of clean to create a model map for usage with restor to</span>
                                            <span class="c1"># give the beam size.</span>
                                            <span class="c1"># JMH:  skip this step for now as it appears not useful and causes crashes</span>
<span class="c1">#                                            clean = lib.miriad(&#39;clean&#39;)</span>
<span class="c1">#                                            clean.map = &#39;map_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            clean.beam = &#39;beam_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            clean.out = &#39;model_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            clean.niters = 1</span>
<span class="c1">#                                            clean.gain = 0.0000001</span>
<span class="c1">#                                            clean.region = &#39;&quot;boxes(1,1,2,2)&quot;&#39;</span>
<span class="c1">#                                            clean.go()</span>
<span class="c1">#                                            restor = lib.miriad(&#39;restor&#39;)</span>
<span class="c1">#                                            restor.model = &#39;model_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            restor.beam = &#39;beam_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            restor.map = &#39;map_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            restor.out = &#39;image_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                            restor.mode = &#39;clean&#39;</span>
<span class="c1">#                                            restor.go()</span>
<span class="c1">#                                            if self.line_image_convolbeam:</span>
<span class="c1">#                                                convol = lib.miriad(&#39;convol&#39;)</span>
<span class="c1">#                                                convol.map = &#39;image_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                                beam_parameters = self.line_image_convolbeam.split(&#39;,&#39;)</span>
<span class="c1">#                                                convol.fwhm = str(beam_parameters[0]) + &#39;,&#39; + str(beam_parameters[1])</span>
<span class="c1">#                                                convol.pa = str(beam_parameters[2])</span>
<span class="c1">#                                                convol.out = &#39;convol_00_&#39; + str(channel_counter).zfill(5)</span>
<span class="c1">#                                                convol.options = &#39;final&#39;</span>
<span class="c1">#                                                convol.go()</span>
<span class="c1">#                                            else:</span>
<span class="c1">#                                                pass</span>
                                        <span class="n">fits</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;xyout&#39;</span>
                                        <span class="n">minc</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_convolbeam</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                                                    <span class="s1">&#39;convol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                            <span class="mi">5</span><span class="p">)):</span>
                                                <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="s1">&#39;convol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                                                    <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                        <span class="mi">5</span><span class="p">)):</span>
                                                <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="s1">&#39;image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="s1">&#39;map_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                    <span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;cube_image_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="s1">&#39;beam_00_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;&quot;images(1,1)&quot;&#39;</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;cube_beam_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
                                        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                            <span class="s1">&#39;(LINE) Finished processing channel &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_counter</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">nchunks</span> <span class="o">*</span> <span class="n">nchannel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span>
                                                <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. (threads [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                <span class="n">p1</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                                <span class="n">p2</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] [1st,2nd]) #&#39;</span><span class="p">)</span>
                                        <span class="c1"># old:</span>
                                        <span class="c1"># channel_counter = channel_counter + 1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># old:</span>
                                    <span class="c1"># channel_counter = channel_counter + 1</span>
                                    <span class="c1"># new:</span>
                                    <span class="k">pass</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) All channels of chunk &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; imaged (thread &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">p1</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; 1st level) #&#39;</span><span class="p">)</span>
                        <span class="c1"># new:</span>
                        <span class="c1"># removal of intermediate files held off until all are done</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39; (LINE) No continuum subtracted data available for chunk &#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;! (thread &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">thread_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of &#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; 1st level)&#39;</span><span class="p">)</span>
            <span class="n">pymp</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">original_nested</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Combining images to line cubes #&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">nchans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nchans</span> <span class="o">=</span> <span class="n">nchunks</span> <span class="o">*</span> <span class="n">nchannel</span>
            <span class="c1"># fix this so that the startfreq is read from the first file that is put into the cube</span>
            <span class="n">startfreq</span> <span class="o">=</span> <span class="n">get_freqstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_channelbinning</span> <span class="o">*</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_linecube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/cube_image_*.fits&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_cube_name</span><span class="p">,</span> <span class="n">nchans</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">startfreq</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Created HI-image cube #&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_linecube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/cube_beam_*.fits&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_image_beam_cube_name</span><span class="p">,</span> <span class="n">nchans</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_image_channels</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">startfreq</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Created HI-beam cube #&#39;</span><span class="p">)</span></div>

            <span class="c1"># Removing the cube data is done separately</span>
            <span class="c1"># logger.info(&#39;(LINE) Removing obsolete files #&#39;)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;ch&#39;, self.linedir)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/??&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/&#39; + self.target, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;image*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;beam*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;model*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;map*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;cube_*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;mask*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;convol*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># subs_managefiles.director(self, &#39;rm&#39;, self.linedir + &#39;/cubes/&#39; + &#39;residual*&#39;, ignore_nonexistent=True)</span>
            <span class="c1"># logger.info(&#39;(LINE) Cleaned up the cubes directory #&#39;)</span>

<div class="viewcode-block" id="line.create_linecube"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.create_linecube">[docs]</a>    <span class="k">def</span> <span class="nf">create_linecube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searchpattern</span><span class="p">,</span> <span class="n">outcube</span><span class="p">,</span> <span class="n">nchannel</span><span class="p">,</span> <span class="n">startchan</span><span class="p">,</span> <span class="n">startfreq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a cube out of a number of input files.</span>
<span class="sd">        searchpattern: Searchpattern for the files to combine in the cube. Uses the usual command line wild cards</span>
<span class="sd">        outcube: Full name and path of the output cube</span>
<span class="sd">        outfreq: Full name and path of the output frequency file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># old:</span>
        <span class="c1"># filelist = glob.glob(searchpattern) # Get a list of the fits files in the directory</span>
        <span class="c1"># new: (old one was basically random, but consistently so across runs; in parallel the order was</span>
        <span class="c1"># completely different)</span>
        <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">searchpattern</span><span class="p">))</span>  <span class="c1"># Get a list of the fits files in the directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">firstfile</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">memmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Open the first file to get the header information and array sizes</span>
            <span class="n">firstheader</span> <span class="o">=</span> <span class="n">firstfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">naxis1</span> <span class="o">=</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
            <span class="n">naxis2</span> <span class="o">=</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>
            <span class="n">firstfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">nancube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nchannel</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startchan</span><span class="p">,</span> <span class="n">startchan</span> <span class="o">+</span> <span class="n">nchannel</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">searchpattern</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
                    <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">searchpattern</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fitsfile_data</span> <span class="o">=</span> <span class="n">fitsfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">nancube</span><span class="p">[</span><span class="n">chan</span> <span class="o">-</span> <span class="n">startchan</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">fitsfile_data</span>
                    <span class="n">fitsfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">firstfile</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">firstheader</span> <span class="o">=</span> <span class="n">firstfile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="c1"># change suggested by JV, added by JMH commented out by JMH</span>
            <span class="n">naxis</span> <span class="o">=</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span>  <span class="c1"># put this line somewhere before that keyword is assigned the value 3</span>
            <span class="c1"># end change</span>
            <span class="c1">#        firstheader[&#39;NAXIS&#39;] = 3    # commented out by JMH</span>
            <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startfreq</span>  <span class="c1"># set this for the beam as well even though the 3rd axis is not FREQ-OBS</span>
            <span class="c1"># we will fix this later when we reorder the beam axes</span>
            <span class="c1"># new:</span>
            <span class="c1"># firstheader[&#39;REFFREQTYPE&#39;] = &#39;BARY&#39;</span>
            <span class="c1"># ideally, the following should be fetched from the original data; so far it&#39;s hard coded (for HI)</span>
            <span class="n">restfreq</span> <span class="o">=</span> <span class="mf">1420405751.77</span>
            <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;RESTFREQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restfreq</span>
            <span class="c1"># changes added by JMH, based on suggestions by JV and NG</span>

            <span class="c1"># if FREQ-OBS is not the 3rd axis (beams) but the 5th then rename the header keywords accordingly</span>
            <span class="c1">#         for keyword in firstheader:</span>

            <span class="k">if</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SDBEAM&quot;</span><span class="p">]:</span>
                <span class="n">sdbeam</span> <span class="o">=</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE4&#39;</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdbeam</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;CTYPE&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RA---NCP&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC--NCP&quot;</span><span class="p">,</span> <span class="s2">&quot;FREQ-OBS&quot;</span><span class="p">]:</span>

                    <span class="c1"># at least if those are the only axes that are allowed; if there are other variaties of RA &amp; DEC,</span>
                    <span class="c1"># those should be put in as well also, I&#39;m assuming it&#39;s FREQ-OBS we want for the 3rd axis</span>
                    <span class="c1"># (both image &amp; beam);</span>
                    <span class="c1"># if it should be something else (or possibly different between image &amp; beam), let me know</span>

                    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CRPIX&quot;</span><span class="p">,</span> <span class="s2">&quot;CDELT&quot;</span><span class="p">,</span> <span class="s2">&quot;CRVAL&quot;</span><span class="p">,</span> <span class="s2">&quot;CTYPE&quot;</span><span class="p">]:</span>
                        <span class="k">del</span> <span class="n">firstheader</span><span class="p">[</span><span class="n">keyword</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]:</span>
                            <span class="k">del</span> <span class="n">firstheader</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
            <span class="c1"># end change</span>
            <span class="n">pyfits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outcube</span><span class="p">,</span> <span class="n">nancube</span><span class="p">,</span> <span class="n">firstheader</span><span class="p">)</span>
            <span class="n">firstfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39; (LINE) Invert produced no images to make a cube &#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.calc_irms"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.calc_irms">[docs]</a>    <span class="k">def</span> <span class="nf">calc_irms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the maximum of an image</span>
<span class="sd">        image (string): The name of the image file. Must be in MIRIAD-format</span>
<span class="sd">        returns (float): the maximum in the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;xyout&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>  <span class="c1"># Open the image</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Get the standard deviation</span>
        <span class="n">image_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the image</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imax</span></div>

<div class="viewcode-block" id="line.calc_imax"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.calc_imax">[docs]</a>    <span class="k">def</span> <span class="nf">calc_imax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the maximum of an image</span>
<span class="sd">        image (string): The name of the image file. Must be in MIRIAD-format</span>
<span class="sd">        returns (float): the maximum in the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;xyout&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>  <span class="c1"># Open the image</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Get the maximum</span>
        <span class="n">image_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the image</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imax</span></div>

<div class="viewcode-block" id="line.calc_max_min_ratio"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.calc_max_min_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">calc_max_min_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the absolute maximum of the ratio max/min and min/max</span>
<span class="sd">        image (string): The name of the image file. Must be in MIRIAD-format</span>
<span class="sd">        returns (float): the ratio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;xyout&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>  <span class="c1"># Open the image</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Get the maximum</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Get the minimum</span>
        <span class="n">max_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imax</span> <span class="o">/</span> <span class="n">imin</span><span class="p">)</span>  <span class="c1"># Calculate the ratios</span>
        <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imin</span> <span class="o">/</span> <span class="n">imax</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">max_min</span><span class="p">,</span> <span class="n">min_max</span><span class="p">])</span>  <span class="c1"># Take the maximum of both ratios and return it</span>
        <span class="n">image_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the image</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratio</span></div>

<div class="viewcode-block" id="line.calc_isum"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.calc_isum">[docs]</a>    <span class="k">def</span> <span class="nf">calc_isum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the sum of the values of the pixels in an image</span>
<span class="sd">        image (string): The name of the image file. Must be in MIRIAD-format</span>
<span class="sd">        returns (float): the sum of the pxiels in the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">miriad</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;xyout&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">in_</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>  <span class="c1"># Open the image</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">isum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Get the maximum</span>
        <span class="n">image_data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the image</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">isum</span></div>

<div class="viewcode-block" id="line.list_chunks"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.list_chunks">[docs]</a>    <span class="k">def</span> <span class="nf">list_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks how many chunk directories exist and returns a list of them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># Stop the counting loop at the directory you cannot find anymore</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">chunkstr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">chunkstr</span></div>

<div class="viewcode-block" id="line.get_last_major_iteration"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.get_last_major_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">get_last_major_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of the last major iteration</span>
<span class="sd">        chunk: The frequency chunk to look into. Usually an entry generated by list_chunks</span>
<span class="sd">        return: The number of the last major clean iteration for a frequency chunk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selfcaldir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># Stop the counting loop at the file you cannot find anymore</span>
        <span class="n">lastmajor</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">lastmajor</span></div>

<div class="viewcode-block" id="line.reset"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to reset the current step and remove all generated data. Be careful! Deletes all data generated in</span>
<span class="sd">        this step!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39; Deleting all line data.&#39;</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setdatasetnamestomiriad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="line.cleanup"><a class="viewcode-back" href="../../../modules/line.html#apercal.modules.line.line.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean_level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Clean all intermediate products. Leaves the HI-image and HI-beam fits cubes in place. </span>

<span class="sd">        There are three levels of cleaning</span>
<span class="sd">        - level 1: cleans all data except the final cubes</span>
<span class="sd">        - level 2: removes the chunks and auxillary files in the cube dir, so it keeps the mir file</span>
<span class="sd">        and existing cubes</span>
<span class="sd">        - level 3: removes only the auxillary files in the cube directory and keeps the chunks, </span>
<span class="sd">        mir file and existing cubes.</span>

<span class="sd">        # Args</span>
<span class="sd">            clean_level (int): level of cleaning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clean_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing all obsolete files #&#39;</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/??&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;image*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;beam*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;model*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;map*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;cube_*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;mask*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;convol*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;residual*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing all obsolete files ... Done #&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clean_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing chunks and image files #&#39;</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/??&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;image*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;beam*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;model*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;map*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;cube_*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;mask*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;convol*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;residual*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing chunks and image files ... Done #&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clean_level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing image files only #&#39;</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;image*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;beam*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;model*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;map*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;cube_*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;mask*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;convol*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedir</span> <span class="o">+</span> <span class="s1">&#39;/cubes/&#39;</span> <span class="o">+</span> <span class="s1">&#39;residual*&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(LINE) Removing image files only ... Done #&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apercal 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Apercal Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>
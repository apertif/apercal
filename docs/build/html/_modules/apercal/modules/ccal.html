
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>apercal.modules.ccal &#8212; Apercal 2.5.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apercal 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for apercal.modules.ccal</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">apercal.libs</span> <span class="k">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">apercal.exceptions</span> <span class="k">import</span> <span class="n">ApercalException</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">ccal_utils</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">param</span> <span class="k">as</span> <span class="n">subs_param</span>
<span class="kn">from</span> <span class="nn">apercal.subs.param</span> <span class="k">import</span> <span class="n">get_param_def</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">calmodels</span> <span class="k">as</span> <span class="n">subs_calmodels</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">msutils</span> <span class="k">as</span> <span class="n">subs_msutils</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">managefiles</span> <span class="k">as</span> <span class="n">subs_managefiles</span>
<span class="kn">from</span> <span class="nn">apercal.subs</span> <span class="k">import</span> <span class="n">setinit</span> <span class="k">as</span> <span class="n">subs_setinit</span>
<span class="kn">from</span> <span class="nn">apercal.modules.base</span> <span class="k">import</span> <span class="n">BaseModule</span>
<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="k">import</span> <span class="n">SafeConfigParser</span><span class="p">,</span> <span class="n">ConfigParser</span>
<span class="kn">import</span> <span class="nn">casacore.tables</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">gencal_cmd</span> <span class="o">=</span> <span class="s1">&#39;gencal(vis=&quot;</span><span class="si">{vis}</span><span class="s1">&quot;, caltable=&quot;</span><span class="si">{caltable}</span><span class="s1">&quot;, caltype=&quot;</span><span class="si">{caltype}</span><span class="s1">&quot;, infile=&quot;</span><span class="si">{infile}</span><span class="s1">&quot;)&#39;</span>


<div class="viewcode-block" id="ccal"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal">[docs]</a><span class="k">class</span> <span class="nc">ccal</span><span class="p">(</span><span class="n">BaseModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crosscal class to handle applying the calibrator gains and prepare the dataset for self-calibration.</span>

<span class="sd">    Crosscal contains several quality checks at two levels for the flux calibrator.</span>
<span class="sd">    First, it checks whether CASA failed to create any of the flux calibrator calibration files and </span>
<span class="sd">    changes references antennas if one failed. Second, it checks the bandpass phase solutions. It will</span>
<span class="sd">    restart with a different reference antenna in case too many telescope failed or just flag the telescopes.</span>
<span class="sd">    Third, it checks the amplitude of the autocorrelation and flags a polarization if they are too high.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="s1">&#39;CROSSCAL&#39;</span>

    <span class="n">crosscaldir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_initial_phase</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_global_delay</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_bandpass</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_gains</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_crosshand_delay</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_leakage</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_polarisation_angle</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_transfer_to_cal</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_transfer_to_target</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_refant</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_refant_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RTC&quot;</span><span class="p">,</span> <span class="s2">&quot;RTD&quot;</span><span class="p">]</span>
    <span class="n">crosscal_ant_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_check_bandpass</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_bandpass_phase_solution_max_std</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_plot_bandpass_phase_solutions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_check_autocorrelation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_plot_autocorrelation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_flag_limit</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">crosscal_try_limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_fluxcal_try_limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_autocorrelation_amp_limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_autocorrelation_data_fraction_limit</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># not for config</span>
    <span class="n">config_file_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crosscal_fluxcal_try_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">crosscal_try_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">crosscal_try_restart</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#crosscal_fluxcal_try_restart_no_refant_change = False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="p">)</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span> <span class="o">=</span> <span class="n">file_</span>

        <span class="c1"># setting some presets if not specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting for checking autocorrelation was not specified. Setting it to default </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting for plotting autocorrelation was not specified. Setting it to default </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of overall crosscal restarts not specified. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of fluxcal calibration restarts not specified. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum number of antennas with at least one polarisation flagged not specified. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_counter</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_amp_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_amp_limit</span> <span class="o">=</span> <span class="mf">1500.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum value of autocorrelation ampliude not specified. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_amp_limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_data_fraction_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_data_fraction_limit</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Limit of the fraction of data with autocorrelation amplitude above maximum value not specified. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_data_fraction_limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check of bandpass solutions not provided. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_bandpass_phase_solutions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_bandpass_phase_solutions</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting for plotting of bandpass solutions not provided. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass_phase_solution_max_std</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass_phase_solution_max_std</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum std of bandpass phase solutions not provided. Setting to default: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass_phase_solution_max_std</span><span class="p">))</span>

<div class="viewcode-block" id="ccal.go"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.go">[docs]</a>    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the full cross calibration process in the following order.</span>
<span class="sd">        setflux</span>
<span class="sd">        initial_phase</span>
<span class="sd">        global_delay</span>
<span class="sd">        bandpass</span>
<span class="sd">        gains</span>
<span class="sd">        crosshand_delay</span>
<span class="sd">        leakage</span>
<span class="sd">        polarisation_angle</span>
<span class="sd">        transfer_to_cal</span>
<span class="sd">        tranfer_to_target</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting CROSS CALIBRATION &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_calibrators</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_to_target</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CROSS CALIBRATION done &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.calibrate_calibrators"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.calibrate_calibrators">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_calibrators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to manage the adaptive calibration of the calibrators.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ccal_calibration_restart</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_restart&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccal_calibration_calibrator_finished</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_calibrator_finished&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccal_calibration_try_counter</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_try_counter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># to break the crosscal loop before the limit</span>
        <span class="n">crosscal_finished</span> <span class="o">=</span> <span class="n">ccal_calibration_calibrator_finished</span>

        <span class="c1"># loop for restarting all of cross-calibration</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">crosscal_finished</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Running cross-calibration attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_restart</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># reset counter for flux calibration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># check the reference antenna</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">()</span>

            <span class="c1"># set the model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setflux</span><span class="p">()</span>

            <span class="c1"># fluxcal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fluxcal</span><span class="p">()</span>

            <span class="c1"># polcal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_polcal</span><span class="p">()</span>

            <span class="c1"># apply solutions</span>
            <span class="c1"># self.apply_solutions()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_to_cal</span><span class="p">()</span>

            <span class="c1"># Technically, this could happen before calibrating the polarisation calibrator</span>
            <span class="c1"># but it is placed here in case checks of the polarised calibrator will be added</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_autocorrelation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_autocorrelation</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Running cross-calibration attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) finished without autocorrelation check.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_restart</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Running cross-calibration attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed autocorrelation check. Going to reset, flag and restart&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>
                    <span class="c1"># checking the number of antennas flagged in total</span>
                    <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_flag_list&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">ccal_flag_list</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span>
                    <span class="c1"># check that the list of flags is below the limit</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccal_flag_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Autocorrelation check found the following flags: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ccal_flag_list</span><span class="p">))</span>
                        <span class="c1"># get a list flagged polarisation</span>
                        <span class="n">pol_flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">ccal_flag_list</span><span class="p">])</span>
                        <span class="c1"># get the flags that have both polarisation flagged</span>
                        <span class="n">n_full_poll_flags_xx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pol_flag_list</span> <span class="o">==</span> <span class="s2">&quot;XX&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">n_full_poll_flags_yy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pol_flag_list</span> <span class="o">==</span> <span class="s2">&quot;YY&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">n_full_poll_flags_xx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span> <span class="ow">or</span> <span class="n">n_full_poll_flags_yy</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">:</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Number of antennas with XX (</span><span class="si">{1}</span><span class="s2">) and YY (</span><span class="si">{2}</span><span class="s2">) flagged  exceeds defined limit </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">n_full_poll_flags_xx</span><span class="p">,</span> <span class="n">n_full_poll_flags_yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Final cross-calibration attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>
                    <span class="n">crosscal_finished</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

                <span class="c1"># reset first (only fluxcal and polcal need to have theire calibration reset)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">do_clearcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_clearcal_fluxcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">do_clearcal_polcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># flagging data</span>
                <span class="c1"># need to do it after restart</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_data</span><span class="p">()</span>

                <span class="c1"># check whether reference antenna was flagged</span>
                <span class="c1"># and change if necessary</span>
                <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_flag_list&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">antenna_flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">ccal_flag_list</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="ow">in</span> <span class="n">antenna_flag_list</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Found reference antenna in list of flagged antennas. Changing reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">(</span><span class="n">check_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># set the counter up</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># set the status parameter</span>
                <span class="n">ccal_calibration_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_restart</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Running cross-calibration attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) passed autocorrelation check. Continuing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_limit</span><span class="p">))</span>
                <span class="n">crosscal_finished</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_restart&#39;</span><span class="p">,</span> <span class="n">ccal_calibration_restart</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_try_counter&#39;</span><span class="p">,</span> <span class="n">ccal_calibration_try_counter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">crosscal_finished</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Cross-calibration was successful&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">ccal_calibration_calibrator_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_calibration_calibrator_finished&#39;</span><span class="p">,</span> <span class="n">ccal_calibration_calibrator_finished</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Cross-calibration failed. Abort&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.calibrate_fluxcal"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.calibrate_fluxcal">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_fluxcal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Running the calibration steps that are specific for the flux calibrator</span>

<span class="sd">        In case one of the calibration steps fails and there is no calibration table, </span>
<span class="sd">        the function restarts and tries to calibrate the flux calibrator</span>
<span class="sd">        with a different reference antenna except for the case that</span>
<span class="sd">        the bandpass phase solution check is failed.</span>
<span class="sd">        The function does not perform a quality check except for the bandpass</span>
<span class="sd">        phase solutions.</span>
<span class="sd">        If an antenna fails the bandpass phase solutions, it is flagged.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># in case crosscal finishes and all is well</span>
        <span class="n">crosscal_fluxcal_finished</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Status parameters to save if restarted and which try it finished</span>
        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Status of model of the flux and polarisation calibrator</span>
        <span class="n">ccal_fluxcal_calibration_restart</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_calibration_restart&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccal_fluxcal_calibration_try_counter</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_calibration_try_counter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># go through the number of tries or break loop if finished</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">crosscal_fluxcal_finished</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) to run calibration taks of flux calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># running initial phase calibration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_phase</span><span class="p">()</span>
            <span class="c1"># if it fails, restart the loop after changing the reference antenna</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span><span class="p">:</span>
                <span class="c1"># unless it is the last attempt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at initial phase calibration. Trying to restart with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="c1"># reset first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">do_clearcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># change refant</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">(</span><span class="n">check_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># set the counter up</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># set the status parameter</span>
                    <span class="n">ccal_fluxcal_calibration_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Final attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at initial phase calibration.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="c1"># running global delay calibration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_delay</span><span class="p">()</span>
            <span class="c1"># if it fails, restart the loop after changing the reference antenna</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span><span class="p">:</span>
                <span class="c1"># unless it is the last attempt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at global delay calibration. Trying to restart with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="c1"># reset first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">do_clearcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># change refant</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">(</span><span class="n">check_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># set the counter up</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># set the status parameter</span>
                    <span class="n">ccal_fluxcal_calibration_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Final attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at global delay calibration.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="c1"># running bandpass calibraiton</span>
            <span class="c1"># check the bandpass phase solutions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandpass</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_check_bandpass</span><span class="p">:</span>
                <span class="c1"># only check if there is a bandpass table and there is no</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking bandpass solutions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_bandpass</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Did not check bandpass solutions because bandpass calibration will restart&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: No check of bandpass phase solutions requested&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="c1"># if bandpass cal fails or there are too many stations with bad solutions</span>
            <span class="c1"># restart the loop after changing the reference antenna</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span><span class="p">:</span>
                <span class="c1"># unless it was the last attempt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed. Flagging bad antennas and restart &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at bandpass calibration. Trying to restart with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="c1"># reset first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">do_clearcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># do not change refant if there is a flag list</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Found the following new flags: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span><span class="p">))</span>
                        <span class="c1"># checking the number of antennas flagged in total</span>
                        <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_flag_list&#39;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">ccal_flag_list</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span>
                        <span class="c1"># check that the list of flags is below the limit</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccal_flag_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: This is the full list of flags for this beam: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ccal_flag_list</span><span class="p">))</span>
                            <span class="c1"># get a list flagged polarisation</span>
                            <span class="n">pol_flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">ccal_flag_list</span><span class="p">])</span>
                            <span class="c1"># get the flags that have both polarisation flagged</span>
                            <span class="n">n_full_poll_flags_xx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pol_flag_list</span> <span class="o">==</span> <span class="s2">&quot;XX&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">n_full_poll_flags_yy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pol_flag_list</span> <span class="o">==</span> <span class="s2">&quot;YY&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">n_full_poll_flags_xx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span> <span class="ow">or</span> <span class="n">n_full_poll_flags_yy</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">:</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Number of antennas with XX (</span><span class="si">{1}</span><span class="s2">) and YY (</span><span class="si">{2}</span><span class="s2">) flagged exceeds defined limit </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">n_full_poll_flags_xx</span><span class="p">,</span> <span class="n">n_full_poll_flags_yy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                            <span class="c1"># flag the data</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">flag_data</span><span class="p">()</span>
                            <span class="c1"># reset temporary list</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># change refant</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Changing reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">(</span>
                            <span class="n">check_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># set the counter up</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># set the status parameter</span>
                    <span class="n">ccal_fluxcal_calibration_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Final attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at bandpass calibration.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gains</span><span class="p">()</span>
            <span class="c1"># if it fails, restart the loop after changing the reference antenna</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span><span class="p">:</span>
                <span class="c1"># unless it was the last attempt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at gain calibration. Trying to restart with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="c1"># reset first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">do_clearcal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># change refant</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_ref_ant</span><span class="p">(</span><span class="n">check_flags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># set the counter up</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># set the status parameter</span>
                    <span class="n">ccal_fluxcal_calibration_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Final attempt </span><span class="si">{1}</span><span class="s2"> (out of </span><span class="si">{2}</span><span class="s2">) failed at gain calibration.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_limit</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="c1"># if this point is reached, crosscalibration should have worked</span>
            <span class="n">crosscal_fluxcal_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># leave the loop</span>
            <span class="k">break</span>

        <span class="c1"># save parameters</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_calibration_restart&#39;</span><span class="p">,</span> <span class="n">ccal_fluxcal_calibration_restart</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_calibration_try_counter&#39;</span><span class="p">,</span> <span class="n">ccal_fluxcal_calibration_try_counter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">crosscal_fluxcal_finished</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Calibration of flux calibrator successful. Continue with pol calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Cross-calibration of flux calibrator was not successful. Abort&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.calibrate_polcal"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.calibrate_polcal">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_polcal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Running the calibration steps that are specific for the pol calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crosshand_delay</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leakage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarisation_angle</span><span class="p">()</span></div>

<div class="viewcode-block" id="ccal.apply_solutions"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.apply_solutions">[docs]</a>    <span class="k">def</span> <span class="nf">apply_solutions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the solutions to the calibrators and the target</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_to_cal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_to_target</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">get_antenna_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># get a list of antennas from the fluxcal MS file</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT NAME FROM </span><span class="si">{}</span><span class="s2">::ANTENNA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">())</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query_result</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="ccal.check_ref_ant"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.check_ref_ant">[docs]</a>    <span class="k">def</span> <span class="nf">check_ref_ant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">change_ref_ant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the default reference antenna.</span>

<span class="sd">        This function tests whether the default reference antenna is </span>
<span class="sd">        available or not. If not, it uses the next antenna. It changes</span>
<span class="sd">        the config file settings for crosscal and selfcal accordingly.</span>
<span class="sd">        RTC and RTD have been excluded because of their performance. </span>
<span class="sd">        At the moment, the function only tests whether the entire reference</span>
<span class="sd">        antenna is flagged.</span>

<span class="sd">        Theses tests are based on the flux calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get the reference antenna</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_antenna_list</span><span class="p">()</span>
        <span class="n">crosscal_refant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Checking reference antenna </span><span class="si">{1}</span><span class="s2"> set in config file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
            <span class="c1"># get a list of antennas from the polcal MS file</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT NAME FROM </span><span class="si">{}</span><span class="s2">::ANTENNA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">())</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">polcal_ant_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query_result</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">polcal_ant_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check that the reference antenna is in the list of antennas</span>
        <span class="n">refant_in_fluxcal</span> <span class="o">=</span> <span class="n">crosscal_refant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span>

        <span class="k">if</span> <span class="n">refant_in_fluxcal</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Reference antenna </span><span class="si">{1}</span><span class="s2"> exists in flux calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># since the reference antenna does not exists, choose the first available one in the list</span>
            <span class="c1"># this should not be RTC and RTD but just in case test it</span>
            <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant_exclude</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Could not find reference antenna </span><span class="si">{1}</span><span class="s2"> in flux calibrator. Chose </span><span class="si">{2}</span><span class="s2"> instead&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">,</span> <span class="n">ant</span><span class="p">))</span>
                    <span class="n">crosscal_refant</span> <span class="o">=</span> <span class="n">ant</span>
                    <span class="n">refant_in_fluxcal</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="c1"># get the index of the reference antenna</span>
        <span class="n">refant_fluxcal_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span> <span class="o">==</span> <span class="n">crosscal_refant</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">check_flags</span><span class="p">:</span>
            <span class="c1"># check if the entire referance antenna is flagged</span>
            <span class="c1"># dropping &quot;==0&quot; would give the number of non-flagged data points</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT GNFALSE(FLAG)==0 as all_flagged FROM </span><span class="si">{0}</span><span class="s2"> WHERE ANTENNA1==</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(),</span> <span class="n">refant_fluxcal_index</span><span class="p">)</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="c1"># if reference antenna is completely flagged, another one needs to be chosen</span>
            <span class="k">if</span> <span class="n">query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;all_flagged&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: All visibilities of reference antenna </span><span class="si">{1}</span><span class="s2"> are flagged. Choosing another one&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
                <span class="c1"># go through the list of antennas</span>
                <span class="n">ant_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">ant_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refant_fluxcal_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span><span class="p">)):</span>
                    <span class="c1"># check if it completely flagged</span>
                    <span class="n">query_ref_search</span> <span class="o">=</span> <span class="s2">&quot;SELECT GNFALSE(FLAG)==0 as all_flagged FROM </span><span class="si">{0}</span><span class="s2"> WHERE ANTENNA1==</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(),</span> <span class="n">ant_index</span><span class="p">)</span>
                    <span class="n">query_ref_search_result</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">query_ref_search</span><span class="p">)</span>
                    <span class="c1"># if this one is not flagged</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">query_ref_search_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;all_flagged&#39;</span><span class="p">]:</span>
                        <span class="c1"># get the name</span>
                        <span class="n">ant_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span><span class="p">[</span><span class="n">ant_index</span><span class="p">]</span>
                        <span class="c1"># check that it is not in the exclude list</span>
                        <span class="k">if</span> <span class="n">ant_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant_exclude</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Choosing </span><span class="si">{1}</span><span class="s2"> as the reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">))</span>
                            <span class="n">crosscal_refant</span> <span class="o">=</span> <span class="n">ant_name</span>
                            <span class="n">refant_fluxcal_index</span> <span class="o">=</span> <span class="n">ant_index</span>
                            <span class="k">break</span>
                <span class="c1"># not sure if this check is necessary</span>
                <span class="k">if</span> <span class="n">ant_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Could not find a new reference antenna. Abort crosscal&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="c1"># reference antenna is not completely flagged</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reference antenna </span><span class="si">{0}</span><span class="s2"> is not completely flagged. Keeping it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">crosscal_refant</span><span class="p">))</span>

        <span class="c1"># another option is to just change the reference antenna</span>
        <span class="k">if</span> <span class="n">change_ref_ant</span><span class="p">:</span>
            <span class="c1"># only if it hasn&#39;t already been changed</span>
            <span class="k">if</span> <span class="n">crosscal_refant</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span><span class="p">:</span>
                <span class="c1"># set the index of the reference antenna one up</span>
                <span class="n">refant_fluxcal_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># get the corresponding reference antenna</span>
                <span class="n">crosscal_refant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_ant_list</span><span class="p">[</span><span class="n">refant_fluxcal_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">crosscal_refant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant_exclude</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Changing reference antenna to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># maybe a restart would be better, in case there is another antenna</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: New reference antenna </span><span class="si">{1}</span><span class="s2"> should be excluded. Abort&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">crosscal_refant</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Chosen reference antenna </span><span class="si">{1}</span><span class="s2"> is different from config file setting. Adjusting settings for crosscal and selfcal&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
                <span class="c1"># set config parser</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
                <span class="c1"># read the config file settings</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

                <span class="c1"># change the setting in crosscal</span>
                <span class="c1"># not strictly necessary here, but good to make the config file consistent</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;CROSSCAL&quot;</span><span class="p">,</span> <span class="s2">&quot;crosscal_refant&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crosscal_refant</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">=</span> <span class="n">crosscal_refant</span>

                <span class="c1"># change the setting in selfcal</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;SELFCAL&quot;</span><span class="p">,</span> <span class="s2">&quot;selfcal_refant&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refant_fluxcal_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># make a copy of old config file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Creating backup of config file before adjusting settings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.cfg&quot;</span><span class="p">,</span> <span class="s2">&quot;_backup_wrong_refant.cfg&quot;</span><span class="p">),</span> <span class="n">file_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># write changes to config file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Writing changes to config file </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: No config file was specified. Cannot adjust setting for selfcal. Changing reference antenna only for crosscal to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">=</span> <span class="n">crosscal_refant</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Reference antenna </span><span class="si">{1}</span><span class="s2"> set in config file is valid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>

        <span class="c1"># Checking polcal but not doing anything at the moment if it fails</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
            <span class="n">refant_in_polcal</span> <span class="o">=</span> <span class="n">crosscal_refant</span> <span class="ow">in</span> <span class="n">polcal_ant_list</span>
            <span class="k">if</span> <span class="n">refant_in_polcal</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Reference antenna </span><span class="si">{1}</span><span class="s2"> exists in polarisation calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Reference antenna </span><span class="si">{1}</span><span class="s2"> does NOT exists in polarisation calibrator. Polarisation will probably fail.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">crosscal_refant</span><span class="p">))</span></div>

<div class="viewcode-block" id="ccal.setflux"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.setflux">[docs]</a>    <span class="k">def</span> <span class="nf">setflux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the models for the flux and polarisation calibrators</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Status of model of the flux and polarisation calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>
            <span class="c1"># Ingest the model of the flux calibrator into the MODEL column</span>
            <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Model was already ingested into the flux calibrator dataset!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get the name of the calibrator</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">::FIELD&quot;</span> <span class="o">%</span> <span class="n">ms</span><span class="p">,</span> <span class="n">ack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">av</span><span class="p">,</span> <span class="n">fluxdensity</span><span class="p">,</span> <span class="n">spix</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="n">rotmeas</span> <span class="o">=</span> <span class="n">subs_calmodels</span><span class="o">.</span><span class="n">get_calparameters</span><span class="p">(</span>
                    <span class="n">srcname</span><span class="p">)</span>
                <span class="n">cc_fluxcal_model</span> <span class="o">=</span> <span class="s1">&#39;setjy(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, scalebychan = True, standard = &quot;manual&quot;, fluxdensity = [&#39;</span> <span class="o">+</span> <span class="n">fluxdensity</span> <span class="o">+</span> <span class="s1">&#39;], spix = [&#39;</span> <span class="o">+</span> <span class="n">spix</span> <span class="o">+</span> <span class="s1">&#39;], reffreq = &quot;&#39;</span> <span class="o">+</span> <span class="n">reffreq</span> <span class="o">+</span> <span class="s1">&#39;&quot;, rotmeas = &#39;</span> <span class="o">+</span> <span class="n">rotmeas</span> <span class="o">+</span> <span class="s1">&#39;, usescratch = True)&#39;</span>
                <span class="k">if</span> <span class="n">av</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Calibrator model not in database for source &#39;</span> <span class="o">+</span> <span class="n">srcname</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalmodel</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="n">ccalpolcalmodel</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_model</span><span class="p">],</span> <span class="n">log_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

                <span class="c1"># Check if model was ingested successfully</span>
                <span class="k">if</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">has_good_modeldata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>
                    <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Model not ingested properly. Flux scale and bandpass corrections will not be right!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Fluxcal not set! No model ingested for flux calibrator!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
            <span class="c1"># Ingest the model of the polarised calibrator into the MODEL column</span>
            <span class="k">if</span> <span class="n">ccalpolcalmodel</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Model was already ingested into the polarised calibrator dataset!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get the name of the calibrator</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">::FIELD&quot;</span> <span class="o">%</span> <span class="n">ms</span><span class="p">,</span> <span class="n">ack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">av</span><span class="p">,</span> <span class="n">fluxdensity</span><span class="p">,</span> <span class="n">spix</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="n">rotmeas</span> <span class="o">=</span> <span class="n">subs_calmodels</span><span class="o">.</span><span class="n">get_calparameters</span><span class="p">(</span>
                    <span class="n">srcname</span><span class="p">)</span>
                <span class="n">cc_polcal_model</span> <span class="o">=</span> <span class="s1">&#39;setjy(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">(</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, scalebychan = True, standard = &quot;manual&quot;, fluxdensity = [&#39;</span> <span class="o">+</span> <span class="n">fluxdensity</span> <span class="o">+</span> <span class="s1">&#39;], spix = [&#39;</span> <span class="o">+</span> <span class="n">spix</span> <span class="o">+</span> <span class="s1">&#39;], reffreq = &quot;&#39;</span> <span class="o">+</span> <span class="n">reffreq</span> <span class="o">+</span> <span class="s1">&#39;&quot;, rotmeas = &#39;</span> <span class="o">+</span> <span class="n">rotmeas</span> <span class="o">+</span> <span class="s1">&#39;, usescratch = True)&#39;</span>
                <span class="k">if</span> <span class="n">av</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Calibrator model not in database for source &#39;</span> <span class="o">+</span> <span class="n">srcname</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalmodel</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="n">ccalpolcalmodel</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ApercalException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_polcal_model</span><span class="p">],</span> <span class="n">log_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

                <span class="c1"># Check if model was ingested successfully</span>
                <span class="k">if</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">has_good_modeldata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
                    <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Model not ingested properly. Polarisation calibration corrections will not be right!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Polcal not set! No model ingested for polarised calibrator!&#39;</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalmodel</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="n">ccalpolcalmodel</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.initial_phase"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.initial_phase">[docs]</a>    <span class="k">def</span> <span class="nf">initial_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial phase calibration for the calibrators</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Status of the initial phase calibration for the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_initial_phase</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating initial phase corrections for flux calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="c1"># Create the initial phase correction tables for the flux calibrator</span>
                    <span class="n">fluxcal_G0ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G0ph&#39;</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalinitialphase</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_G0ph</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Initial phase gain table for flux calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gaincal_cmd</span> <span class="o">=</span> <span class="s1">&#39;gaincal(vis=&quot;</span><span class="si">{vis}</span><span class="s1">&quot;, caltable=&quot;</span><span class="si">{caltable}</span><span class="s1">&quot;, gaintype=&quot;G&quot;, solint=&quot;int&quot;, &#39;</span> \
                                      <span class="s1">&#39;refant=&quot;</span><span class="si">{refant}</span><span class="s1">&quot;, calmode = &quot;</span><span class="si">{calmode}</span><span class="s1">&quot;)&#39;</span>

                        <span class="n">cc_fluxcal_ph</span> <span class="o">=</span> <span class="n">gaincal_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(</span>
                        <span class="p">),</span> <span class="n">caltable</span><span class="o">=</span><span class="n">fluxcal_G0ph</span><span class="p">,</span> <span class="n">calmode</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">refant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span><span class="p">)</span>

                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_ph</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if calibration table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_G0ph</span><span class="p">):</span>
                            <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                                <span class="s1">&#39;: Initial phase calibration table for flux calibrator was not created successfully!&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

                            <span class="c1"># leaving function in order to restart</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>
                            <span class="c1">#subs_param.add_param(self, cbeam + &#39;_fluxcal_initialphase&#39;, ccalfluxcalinitialphase)</span>
                            <span class="c1">#raise RuntimeError(error)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Initial phase calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalinitialphase</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Flux calibrator dataset not specified or dataset not available. Cross calibration will probably not work!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalinitialphase</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Initial phase calibration for flux calibrator switched off!&#39;</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalinitialphase</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.global_delay"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.global_delay">[docs]</a>    <span class="k">def</span> <span class="nf">global_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the global delay corrections from the flux calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the global delay correction step</span>

        <span class="c1"># Status of model of the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the initial phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_global_delay</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating global delay corrections for flux calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="c1"># Create the global delay correction table for the flux calibrator</span>
                    <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_K</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Global delay correction table for flux calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="c1"># Check for the initial phase calibration tbales</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalinitialphase</span><span class="p">:</span>
                            <span class="n">fluxcal_G0ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G0ph&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_G0ph</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_fluxcal_globaldelay</span> <span class="o">=</span> <span class="s1">&#39;gaincal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;, caltable = &quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, combine = &quot;scan&quot;, gaintype = &quot;K&quot;, solint = &quot;inf&quot;, refant = &quot;&#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> \
                            <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_globaldelay</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if delay table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_K</span><span class="p">):</span>
                            <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Global delay correction table for flux calibrator was not created successfully!&#39;</span><span class="p">)</span>

                            <span class="c1"># leaving function in order to restart</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Global delay calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Flux calibrator dataset not specified or dataset not available. Cross calibration will probably not work!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Global Delay calibration for flux calibrator switched off!&#39;</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.bandpass"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.bandpass">[docs]</a>    <span class="k">def</span> <span class="nf">bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the bandpass correction table using the flux calibrator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the bandpass correction step</span>

        <span class="c1"># Status of model of the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the initial phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalinitialphase</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating bandpass corrections for flux calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="c1"># Calculate the bandpass for the flux calibrator</span>
                    <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_bscan</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Bandpass for flux calibrator was already derived successfully!&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalinitialphase</span><span class="p">:</span>
                            <span class="n">fluxcal_G0ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G0ph&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span><span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span>
                                                                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_G0ph</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">bandpass_cmd</span> <span class="o">=</span> <span class="s1">&#39;bandpass(vis=&quot;</span><span class="si">{vis}</span><span class="s1">&quot;, caltable=&quot;</span><span class="si">{caltable}</span><span class="s1">&quot;, solint=&quot;inf&quot;, combine=&quot;scan, obs&quot;, &#39;</span> \
                                       <span class="s1">&#39;refant=&quot;</span><span class="si">{refant}</span><span class="s1">&quot;, solnorm=True, gaintable=[</span><span class="si">{gaintable}</span><span class="s1">], interp=[</span><span class="si">{interp}</span><span class="s1">])&#39;</span>

                        <span class="n">cc_fluxcal_bp</span> <span class="o">=</span> <span class="n">bandpass_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(),</span>
                                                            <span class="n">caltable</span><span class="o">=</span><span class="n">fluxcal_bscan</span><span class="p">,</span>
                                                            <span class="n">refant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span><span class="p">,</span>
                                                            <span class="n">gaintable</span><span class="o">=</span><span class="n">prevtables</span><span class="p">,</span>
                                                            <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>

                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_bp</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if bandpass table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_bscan</span><span class="p">):</span>
                            <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                                <span class="s1">&#39;: Initial bandpass calibration table for flux calibrator was not created successfully!&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

                            <span class="c1"># leaving function in order to restart</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>
                            <span class="c1">#subs_param.add_param(self, cbeam + &#39;_fluxcal_bandpass&#39;, ccalfluxcalbandpass)</span>
                            <span class="c1">#raise RuntimeError(error)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Bandpass calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalbandpass</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Flux calibrator dataset </span><span class="si">{}</span><span class="s1"> not specified or dataset not available. Bandpass corrections &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;are not available!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Bandpass calibration for flux calibrator switched off!&#39;</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalbandpass</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.check_bandpass"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.check_bandpass">[docs]</a>    <span class="k">def</span> <span class="nf">check_bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to check the quality of the bandpass phase solutions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking bandpass solutions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="c1"># path to bandpass table</span>
        <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>

        <span class="c1"># if there is a table check it</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_bscan</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_bandpass_phase_solutions</span><span class="p">:</span>
                <span class="c1"># set plot name</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdirification</span><span class="p">:</span>
                    <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s2">&quot;qa/crosscal/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plot_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
                <span class="n">bp_plot_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/BP_phase_Beam_</span><span class="si">{1}</span><span class="s1">_ccal_</span><span class="si">{2}</span><span class="s1">_</span><span class="si">{3}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">plot_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_counter</span><span class="p">)</span>

                <span class="c1"># this function returns a dictionary with true for good and false for bad solutions</span>
                <span class="n">bpass_check_results</span> <span class="o">=</span> <span class="n">ccal_utils</span><span class="o">.</span><span class="n">check_bpass_phase</span><span class="p">(</span>
                    <span class="n">fluxcal_bscan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass_phase_solution_max_std</span><span class="p">,</span> <span class="n">plot_name</span><span class="o">=</span><span class="n">bp_plot_name</span><span class="p">,</span> <span class="n">beam</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this function returns a dictionary with true for good and false for bad solutions</span>
                <span class="n">bpass_check_results</span> <span class="o">=</span> <span class="n">ccal_utils</span><span class="o">.</span><span class="n">check_bpass_phase</span><span class="p">(</span>
                    <span class="n">fluxcal_bscan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_bandpass_phase_solution_max_std</span><span class="p">)</span>

            <span class="c1"># now go through the list</span>
            <span class="c1"># get the number of antennas with bad solutions</span>
            <span class="n">n_ant_bad</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># get a list of bad antennas</span>
            <span class="n">bad_ant_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># also check if both RTC and RTD are bad</span>
            <span class="n">rtc_bad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">rtd_bad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">bpass_check_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># they are bad if values are False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Bandpass check found antenna with bad solutions: </span><span class="si">{1}</span><span class="s2"> (XX: </span><span class="si">{2}</span><span class="s2">, YY: </span><span class="si">{3}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="c1"># increase the counter</span>
                    <span class="n">n_ant_bad</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># check whether RTC and RTD are bad</span>
                    <span class="k">if</span> <span class="n">ant</span> <span class="o">==</span> <span class="s2">&quot;RTC&quot;</span><span class="p">:</span>
                        <span class="n">rtc_false</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">ant</span> <span class="o">==</span> <span class="s2">&quot;RTD&quot;</span><span class="p">:</span>
                        <span class="n">rtd_false</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># add antenna to list</span>
                    <span class="n">bad_ant_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Found </span><span class="si">{1}</span><span class="s2"> antennas with bad solutions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">n_ant_bad</span><span class="p">))</span>

            <span class="c1"># if there are more than the survey requirements allow,</span>
            <span class="c1"># enable restart with a different reference antenna</span>
            <span class="k">if</span> <span class="n">n_ant_bad</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Number of antennas with bad phase solutions exceeds defined limit: </span><span class="si">{1}</span><span class="s2">. Going to restart flux calibrator calibration with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># return</span>
            <span class="k">elif</span> <span class="n">rtc_bad</span> <span class="ow">and</span> <span class="n">rtd_bad</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: RTC and RTD have bad phase solutions exceeding survey requirements. Going to restart flux calibrator calibration with different reference antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># return</span>
            <span class="k">elif</span> <span class="n">n_ant_bad</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Number of antennas with bad phase solutions below defined limit: </span><span class="si">{1}</span><span class="s2">. Going to flag the affected antennas/polarisations and restart&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_limit</span><span class="p">))</span>
                <span class="c1"># get the list of flags</span>
                <span class="n">bandpass_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">bad_ant</span> <span class="ow">in</span> <span class="n">bad_ant_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">bad_ant</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">bandpass_flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bad_ant</span><span class="p">,</span> <span class="s1">&#39;XX&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bpass_check_results</span><span class="p">[</span><span class="n">bad_ant</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">bandpass_flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bad_ant</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="n">bandpass_flag_list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Found no antennas with bad solutions. All good.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking bandpass solutions ... Done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span></div>

<div class="viewcode-block" id="ccal.gains"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.gains">[docs]</a>    <span class="k">def</span> <span class="nf">gains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the amplitude and phase gains for the flux calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the gain correction step</span>

        <span class="c1"># Status of model of the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_gains</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating gain corrections for flux calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>

                    <span class="c1"># Create the amplitude and phase correction table for the flux calibrator</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalapgains</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_g1ap</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Initial gain table for flux calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the delay table to apply on the fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>
                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span><span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span>
                                                                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>
                        <span class="n">cc_fluxcal_apgain</span> <span class="o">=</span> <span class="s1">&#39;gaincal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;, caltable = &quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;, gaintype = &quot;G&quot;, solint = &quot;int&quot;, refant = &quot;&#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, calmode = &quot;ap&quot;, gaintable = [&#39;</span> <span class="o">+</span> \
                            <span class="n">prevtables</span> <span class="o">+</span> <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_apgain</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if gain table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_g1ap</span><span class="p">):</span>
                            <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                                <span class="s1">&#39;: Gain calibration table for flux calibrator was not created successfully!&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

                            <span class="c1"># leaving function in order to restart</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_fluxcal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span>

                            <span class="c1">#subs_param.add_param(self, cbeam + &#39;_fluxcal_apgains&#39;, ccalfluxcalapgains)</span>
                            <span class="c1">#raise RuntimeError(error)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Gain calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalapgains</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Flux calibrator dataset not specified or dataset </span><span class="si">{}</span><span class="s1"> not available. Cross calibration will probably not work!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalapgains</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                           <span class="s1">&#39;: Gain calibration for flux calibrator switched off!&#39;</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalapgains</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.crosshand_delay"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.crosshand_delay">[docs]</a>    <span class="k">def</span> <span class="nf">crosshand_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the cross-hand delay corrections from the polarised calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the cross hand delay correction step</span>

        <span class="c1"># Status of model of the polarised calibrator</span>
        <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the cross hand delay calibration from the polarised calibrator</span>
        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_crosshand_delay</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating cross-hand delay corrections for polarised calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalpolcalmodel</span><span class="p">:</span>

                    <span class="c1"># Create the cross hand delay correction table for the polarised calibrator</span>

                    <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                    <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">polcal_Kcross</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Cross hand delay correction table for polarised calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                            <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_polcal_crosshanddelay</span> <span class="o">=</span> <span class="s1">&#39;gaincal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;, caltable = &quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, combine = &quot;scan&quot;, gaintype = &quot;KCROSS&quot;, solint = &quot;inf&quot;, refant = &quot;&#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> \
                            <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_polcal_crosshanddelay</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if the cross hand delay table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">polcal_Kcross</span><span class="p">):</span>
                            <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Cross hand delay correction table for polarised calibrator was &#39;</span>
                                         <span class="s1">&#39;not created successfully!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for polarised calibrator not ingested properly. Cross hand delay calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Polarised calibrator dataset not specified or dataset not available. Polarisation &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;calibration will probably not work!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.leakage"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.leakage">[docs]</a>    <span class="k">def</span> <span class="nf">leakage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the leakage corrections from the flux calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the leakage correction step</span>

        <span class="c1"># Status of model of the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the cross hand delay calibration from the polarised calibrator</span>
        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the leakage corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_leakage</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating leakage corrections for flux calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="c1"># Create the leakage correction table for the flux calibrator</span>

                    <span class="n">fluxcal_Df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalleakage</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_Df</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Leakage correction table for flux calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                            <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the cross hand calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">:</span>
                            <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_fluxcal_leakage</span> <span class="o">=</span> <span class="s1">&#39;polcal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;, caltable = &quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_Df</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, combine = &quot;scan&quot;, poltype = &quot;Df&quot;, solint = &quot;inf&quot;, refant = &quot;&#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> \
                            <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_fluxcal_leakage</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if gain table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fluxcal_Df</span><span class="p">):</span>
                            <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Leakage correction table for flux calibrator was not created successfully!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Leakage calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalleakage</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Flux calibrator dataset not specified or dataset not available. Cross calibration will probably not work!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalleakage</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="n">ccalfluxcalleakage</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.polarisation_angle"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.polarisation_angle">[docs]</a>    <span class="k">def</span> <span class="nf">polarisation_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the polarisation angle corrections from the polarised calibrator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the polarisation angle correction step</span>

        <span class="c1"># Status of model of the polarised calibrator</span>
        <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the cross hand delay calibration from the polarised calibrator</span>
        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the leakage corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the polarisation angle corrections for the polarised calibrator</span>
        <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">subs_calmodels</span><span class="o">.</span><span class="n">is_polarised</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polcal</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_polarisation_angle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_polarisation_angle</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Changing crosscal_polarisation angle to false because &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">+</span>
                           <span class="s1">&#39;is unpolarised.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_polarisation_angle</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Calculating polarisation angle corrections for polarised calibrator&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
                <span class="c1"># Create the polarisation angle correction table for the polarised calibrator</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalpolcalmodel</span><span class="p">:</span>

                    <span class="n">polcal_Xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Xf&#39;</span>
                    <span class="k">if</span> <span class="n">ccalpolcalpolarisationangle</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">polcal_Xf</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Polarisation angle correction table for polarised calibrator was already generated&#39;</span><span class="p">)</span>
                        <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                            <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the cross hand calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">:</span>
                            <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the leakage calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalleakage</span><span class="p">:</span>
                            <span class="n">fluxcal_Df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_Df</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_polcal_polarisationangle</span> <span class="o">=</span> <span class="s1">&#39;polcal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;, caltable = &quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Xf</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, combine = &quot;scan&quot;, poltype = &quot;Xf&quot;, solint = &quot;inf&quot;, refant = &quot;&#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_refant</span> <span class="o">+</span> \
                            <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> \
                            <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">cc_polcal_polarisationangle</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="c1"># Check if gain table was created successfully</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">polcal_Xf</span><span class="p">):</span>
                            <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Polarisation angle correction table for polarised calibrator &#39;</span>
                                         <span class="s1">&#39;was not created successfully!&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for polarised calibrator not ingested properly. Polarisation angle calibration not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="n">ccalpolcalpolarisationangle</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Polarised calibrator dataset not specified or dataset not available.&#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;Cross calibration will probably not work!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="n">ccalpolcalpolarisationangle</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.transfer_to_cal"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.transfer_to_cal">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_to_cal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the correction tables to the calibrators</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the transfer step</span>

        <span class="c1"># Status of model of the flux calibrator</span>
        <span class="n">ccalfluxcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of model of the polarised calibrator</span>
        <span class="n">ccalpolcalmodel</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the cross hand delay calibration from the polarised calibrator</span>
        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the leakage corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the polarisation angle corrections for the polarised calibrator</span>
        <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the solution transfer for the flux calibrator</span>
        <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the solution transfer for the polarised calibrator</span>
        <span class="n">ccalpolcaltransfer</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_transfer_to_cal</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Applying solutions to calibrators&#39;</span><span class="p">)</span>

            <span class="c1"># Apply solutions to the flux calibrator</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalfluxcalmodel</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">ccalfluxcaltransfer</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Solution tables were already applied to flux calibrator&#39;</span><span class="p">)</span>
                        <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Check which calibration tables are available for the flux calibrator</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                            <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the cross hand calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">:</span>
                            <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the leakage calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalleakage</span><span class="p">:</span>
                            <span class="n">fluxcal_Df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_Df</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the polarisation angle calibration on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalpolarisationangle</span><span class="p">:</span>
                            <span class="n">polcal_Xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Xf&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Xf</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_fluxcal_saveflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;save&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                        <span class="n">cc_fluxcal_apply</span> <span class="o">=</span> <span class="s1">&#39;applycal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;], parang = False, flagbackup = False)&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">cc_fluxcal_saveflags</span><span class="p">,</span> <span class="n">cc_fluxcal_apply</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">has_correcteddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()):</span>
                            <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Corrected visibilities were not written to flux calibrator dataset !&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for flux calibrator not ingested properly. Application of cross calibration solutions not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalfluxcaltransfer</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalpolcaltransfer</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Flux calibrator dataset not specified or dataset not available. Application of cross calibration solutions not possible!&#39;</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalfluxcaltransfer</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalpolcaltransfer</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

            <span class="c1"># Apply solutions to the polarised calibrator</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>

                <span class="c1"># Check if model was ingested properly</span>
                <span class="k">if</span> <span class="n">ccalpolcalmodel</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">ccalpolcaltransfer</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Solution tables were already applied to the polarised calibrator&#39;</span><span class="p">)</span>
                        <span class="n">ccalpolcaltransfer</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Check which calibration tables are available for the polarised calibrator</span>
                        <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                        <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                        <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                            <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                            <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                            <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the cross hand calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">:</span>
                            <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the leakage calibration table to apply on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalfluxcalleakage</span><span class="p">:</span>
                            <span class="n">fluxcal_Df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_Df</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="c1"># Check for the polarisation angle calibration on-the-fly</span>
                        <span class="k">if</span> <span class="n">ccalpolcalpolarisationangle</span><span class="p">:</span>
                            <span class="n">polcal_Xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Xf&#39;</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                                <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Xf</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                        <span class="n">cc_polcal_saveflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">(</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;save&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                        <span class="n">cc_polcal_apply</span> <span class="o">=</span> <span class="s1">&#39;applycal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">(</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;], parang = False, flagbackup = False)&#39;</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">cc_polcal_saveflags</span><span class="p">,</span> <span class="n">cc_polcal_apply</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">has_correcteddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()):</span>
                            <span class="n">ccalpolcaltransfer</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ccalpolcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Corrected visibilities were not written to polarised calibrator dataset !&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccalpolcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                        <span class="s1">&#39;: Model for polarised calibrator not ingested properly. Application of cross calibration solutions not possible!&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalfluxcaltransfer</span><span class="p">)</span>
                    <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalpolcaltransfer</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccalfluxcaltransfer</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: Polarised calibrator dataset not specified or dataset not available. Application of cross calibration solutions not possible!&#39;</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalfluxcaltransfer</span><span class="p">)</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalpolcaltransfer</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="c1"># do not raise exception as it prevents the pipeline from running with fluxcal-only</span>
                <span class="c1"># raise RuntimeError(error)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalfluxcaltransfer</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="n">ccalpolcaltransfer</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.transfer_to_target"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.transfer_to_target">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the correction tables to the target beams</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawsubdir_path</span><span class="p">())</span>

        <span class="c1"># Create the parameters for the parameter file for the transfer step</span>

        <span class="c1"># Status of the solution transfer for the target beams</span>
        <span class="c1"># Status of the global delay corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalglobaldelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the bandpass table of the flux calibrator</span>
        <span class="n">ccalfluxcalbandpass</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the amplitude and phase gains for the flux calibrator</span>
        <span class="n">ccalfluxcalapgains</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the cross hand delay calibration from the polarised calibrator</span>
        <span class="n">ccalpolcalcrosshanddelay</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the leakage corrections for the flux calibrator</span>
        <span class="n">ccalfluxcalleakage</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Status of the polarisation angle corrections for the polarised calibrator</span>
        <span class="n">ccalpolcalpolarisationangle</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ccaltargetbeamstransfer</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_transfer_to_target</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                        <span class="s1">&#39;: Applying solutions to target dataset&#39;</span><span class="p">)</span>

            <span class="c1"># Apply solutions to the target beams</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ccaltargetbeamstransfer</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Solutions were already applied to target dataset&#39;</span><span class="p">)</span>
                    <span class="n">ccaltargetbeamstransfer</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check which calibration tables are available for each beam</span>
                    <span class="n">prevtables</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
                    <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&#39;</span>

                    <span class="c1"># Check for the global delay table to apply on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalglobaldelay</span><span class="p">:</span>
                        <span class="n">fluxcal_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_K</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check for the bandpass calibration table to apply on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalbandpass</span><span class="p">:</span>
                        <span class="n">fluxcal_bscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_bscan</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check for the gain calibration table to apply on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalapgains</span><span class="p">:</span>
                        <span class="n">fluxcal_g1ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_g1ap</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check for the cross hand calibration table to apply on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalpolcalcrosshanddelay</span><span class="p">:</span>
                        <span class="n">polcal_Kcross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Kcross</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check for the leakage calibration table to apply on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalfluxcalleakage</span><span class="p">:</span>
                        <span class="n">fluxcal_Df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">fluxcal_Df</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check for the polarisation angle calibration on-the-fly</span>
                    <span class="k">if</span> <span class="n">ccalpolcalpolarisationangle</span><span class="p">:</span>
                        <span class="n">polcal_Xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Xf&#39;</span>
                        <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span> <span class="o">=</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">add_caltables</span><span class="p">(</span>
                            <span class="n">prevtables</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">polcal_Xf</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;nearest&quot;&#39;</span><span class="p">)</span>

                    <span class="c1"># Execute the CASA command to apply the solutions</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                                 <span class="s1">&#39;: Applying solutions to target dataset&#39;</span><span class="p">)</span>
                    <span class="n">cc_targetbeams_saveflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">(</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;save&quot;, versionname = &quot;ccal&quot;)&#39;</span>  <span class="c1"># Save the flags before applying solutions</span>
                    <span class="n">cc_targetbeams_apply</span> <span class="o">=</span> <span class="s1">&#39;applycal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">(</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;, gaintable = [&#39;</span> <span class="o">+</span> <span class="n">prevtables</span> <span class="o">+</span> <span class="s1">&#39;], interp = [&#39;</span> <span class="o">+</span> <span class="n">interp</span> <span class="o">+</span> <span class="s1">&#39;], parang = False, flagbackup = False)&#39;</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_targetbeams_saveflags</span><span class="p">,</span>
                                  <span class="n">cc_targetbeams_apply</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">subs_msutils</span><span class="o">.</span><span class="n">has_correcteddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">()):</span>
                        <span class="n">ccaltargetbeamstransfer</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ccaltargetbeamstransfer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Corrected visibilities were not written to target dataset!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccaltargetbeamstransfer</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> \
                    <span class="s1">&#39;: No target dataset specified or target dataset not available! Not applying solutions to target dataset&#39;</span>
                <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_transfer&#39;</span><span class="p">,</span> <span class="n">ccaltargetbeamstransfer</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_transfer&#39;</span><span class="p">,</span> <span class="n">ccaltargetbeamstransfer</span><span class="p">)</span></div>

<div class="viewcode-block" id="ccal.check_autocorrelation"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.check_autocorrelation">[docs]</a>    <span class="k">def</span> <span class="nf">check_autocorrelation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the autocorrelation in relation to expected values and flag data</span>
<span class="sd">        if necessary.</span>

<span class="sd">        The function will check the autocorrelation for each telescope in XX and YY</span>
<span class="sd">        with respect to an expected distribution. It will check the relative offset </span>
<span class="sd">        and the to some extent the shape of the autocorrelation. If one or the other</span>
<span class="sd">        shows an issue, the polarisation of this telescope will get flagged</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking autocorrelation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="c1"># check only the flux calibrator</span>
        <span class="n">msfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span>

        <span class="c1"># get the names of all antennas</span>
        <span class="n">taql_antnames</span> <span class="o">=</span> <span class="s2">&quot;SELECT NAME FROM </span><span class="si">{0}</span><span class="s2">::ANTENNA&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msfile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">taql_antnames</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">ant_names</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ant_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;No antenna names available from the MS file. Abort&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># then get frequencies:</span>
        <span class="n">taql_freq</span> <span class="o">=</span> <span class="s2">&quot;SELECT CHAN_FREQ FROM </span><span class="si">{0}</span><span class="s2">::SPECTRAL_WINDOW&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msfile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">taql_freq</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CHAN_FREQ&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;No frequency information available from the MS file. Abort&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># and number of stokes params</span>
        <span class="n">taql_stokes</span> <span class="o">=</span> <span class="s2">&quot;SELECT abs(DATA) AS amp from </span><span class="si">{0}</span><span class="s2"> limit 1&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msfile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_pol</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">taql_stokes</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">pol_array</span> <span class="o">=</span> <span class="n">t_pol</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pol_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;No polarisation information available from the MS file. Abort&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">n_stokes</span> <span class="o">=</span> <span class="n">pol_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># shape is time, one, nstokes</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Inspecting autocorrelation of each antenna&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>

        <span class="c1"># list of flags</span>
        <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#flag_pol = []</span>
        <span class="c1"># list of polarisation</span>
        <span class="c1"># 0 = &#39;XX&#39;, 3 = &#39;YY&#39;</span>
        <span class="n">pol_list_ms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">pol_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XX&#39;</span><span class="p">,</span> <span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;YX&#39;</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">]</span>

        <span class="c1"># for the plots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
            <span class="c1"># only what is set in plot_list_ms will be used</span>
            <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">]</span>
            <span class="n">color_list_high</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C9&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C10&quot;</span><span class="p">]</span>
            <span class="c1"># fixing plot limits of y-axis</span>
            <span class="n">y_min</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="mi">2000</span>
            <span class="c1"># setting plot layout</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">xsize</span> <span class="o">=</span> <span class="n">nx</span><span class="o">*</span><span class="mi">4</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">ny</span><span class="o">*</span><span class="mi">4</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                <span class="s1">&#39;Autocorrelation of Beam </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdirification</span><span class="p">:</span>
                <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="s2">&quot;qa/crosscal/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

        <span class="c1"># take MS file and get calibrated data</span>
        <span class="c1"># amp_ant_array = np.empty(</span>
        <span class="c1">#     (len(ant_names), len(freqs), n_stokes), dtype=np.float64)</span>
        <span class="k">for</span> <span class="n">ant</span><span class="p">,</span> <span class="n">ant_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ant_names</span><span class="p">):</span>
            <span class="c1"># getting the autocorrelation amplitude</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">taql_command</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT abs(gmeans(CORRECTED_DATA[FLAG])) AS amp &quot;</span>
                                <span class="s2">&quot;FROM </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;WHERE ANTENNA1==ANTENNA2 &amp;&amp; (ANTENNA1=</span><span class="si">{1}</span><span class="s2"> || ANTENNA2=</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msfile</span><span class="p">,</span> <span class="n">ant</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">taql</span><span class="p">(</span><span class="n">taql_command</span><span class="p">)</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">)</span>
                <span class="n">amp_ant</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Could not get autocorrelation information for antenna </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># get XX and YY</span>
            <span class="c1"># amp_XX = amp_ant[:, 0]</span>
            <span class="c1"># amp_YY = amp_ant[:, 3]</span>
            <span class="c1"># freqs_XX_selected = freqs[np.where(amp_XX != 0)[0]]</span>
            <span class="c1"># amp_XX_selected = amp_XX[np.where(amp_XX != 0)[0]]</span>
            <span class="c1"># freqs_YY_selected = freqs[np.where(amp_YY != 0)[0]]</span>
            <span class="c1"># amp_YY_selected = amp_YY[np.where(amp_YY != 0)[0]]</span>

            <span class="c1"># for the plots</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ant</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">: Checking autocorrelation amplitude of antenna </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pol_nr</span> <span class="ow">in</span> <span class="n">pol_list_ms</span><span class="p">:</span>
                <span class="n">amp</span> <span class="o">=</span> <span class="n">amp_ant</span><span class="p">[:,</span> <span class="n">pol_nr</span><span class="p">]</span>
                <span class="n">freqs_selected</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">amp_selected</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">amp_selected</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">, Antenna </span><span class="si">{1}</span><span class="s2"> (polarization </span><span class="si">{2}</span><span class="s2">): No autocorrelation data available&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">,</span> <span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">]))</span>
                    <span class="k">continue</span>

                <span class="n">ratio_vis_above_limit</span> <span class="o">=</span> <span class="n">ccal_utils</span><span class="o">.</span><span class="n">get_ratio_autocorrelation_above_limit</span><span class="p">(</span>
                    <span class="n">amp_selected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_amp_limit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ratio_vis_above_limit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_autocorrelation_data_fraction_limit</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">, Antenna </span><span class="si">{1}</span><span class="s2"> (polarization </span><span class="si">{2}</span><span class="s2">): fraction of autocorrelation data above amplitude threshold: </span><span class="si">{3}</span><span class="s2"> =&gt; Flagging polarisation </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">,</span> <span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">],</span> <span class="n">ratio_vis_above_limit</span><span class="p">))</span>
                    <span class="n">ccal_flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">]])</span>
                    <span class="c1">#flag_ant = flag_ant.append(ant_name)</span>
                    <span class="c1">#flag_pol = flag_pol.append(pol_list[pol_nr])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Beam </span><span class="si">{0}</span><span class="s2">, Antenna </span><span class="si">{1}</span><span class="s2"> (polarization </span><span class="si">{2}</span><span class="s2">): fraction of autocorrelation data above amplitude threshold: </span><span class="si">{3}</span><span class="s2"> =&gt; No flagging&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">,</span> <span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">],</span> <span class="n">ratio_vis_above_limit</span><span class="p">))</span>

                <span class="c1"># plot the data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freqs_selected</span><span class="p">,</span> <span class="n">amp_selected</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">]),</span>
                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">]))</span>
                    <span class="c1"># indicate values above plot maximum</span>
                    <span class="n">high_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amp_selected</span> <span class="o">&gt;</span> <span class="n">y_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freqs_selected</span><span class="p">[</span><span class="n">high_values</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">high_values</span><span class="p">),</span> <span class="n">y_max</span> <span class="o">-</span> <span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">pol_nr</span><span class="p">)),</span>
                                    <span class="n">marker</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&gt;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pol_list</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">],</span> <span class="n">y_max</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color_list_high</span><span class="p">[</span><span class="n">pol_nr</span><span class="p">]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Antenna </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ant_name</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

            <span class="c1"># run check of fit to autocorrelation</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking fit of autocorrelation not yet available&quot;</span><span class="p">)</span>

        <span class="c1"># change the legend and save the file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/Autocorrelation_Beam_</span><span class="si">{1}</span><span class="s1">_ccal_</span><span class="si">{2}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">plot_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_counter</span><span class="p">))</span>

        <span class="c1"># cannot flag here only set restart</span>
        <span class="c1"># need to flag after resetting, otherwise flags are gone</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccal_flag_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found data for flagging. Setting restart&quot;</span><span class="p">)</span>

            <span class="c1"># for ant, pol in zip(flag_ant, flag_pol):</span>
            <span class="c1">#     # call function for flagging</span>
            <span class="c1">#     flag_data(polarisation = flag_pol, antenna = ant)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_try_restart</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="n">ccal_flag_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># close all plots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_plot_autocorrelation</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Checking autocorrelation ... Done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span></div>

<div class="viewcode-block" id="ccal.flag_data"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.flag_data">[docs]</a>    <span class="k">def</span> <span class="nf">flag_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to flag a polarisation for a given antenna</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_flag_list&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ccal_flag_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of flux calibrator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span><span class="p">))</span>
            <span class="c1"># create a casa-conform list</span>
            <span class="n">casa_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;antenna=&#39;</span><span class="si">{0}</span><span class="s2">&#39; correlation=&#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span><span class="p">]</span>
            <span class="n">flag_cmd</span> <span class="o">=</span> <span class="s1">&#39;flagdata(vis=&quot;</span><span class="si">{0}</span><span class="s1">&quot;, mode=&quot;list&quot;, inpfile=</span><span class="si">{1}</span><span class="s1">, flagbackup=False)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">(),</span> <span class="n">casa_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">flag_cmd</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">flag_cmd</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of flux calibrator </span><span class="si">{}</span><span class="s2"> ... Done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of polarisation calibrator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span><span class="p">))</span>
            <span class="c1"># create a casa-conform list</span>
            <span class="n">casa_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;antenna=&#39;</span><span class="si">{0}</span><span class="s2">&#39; correlation=&#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span><span class="p">]</span>
            <span class="n">flag_cmd</span> <span class="o">=</span> <span class="s1">&#39;flagdata(vis=&quot;</span><span class="si">{0}</span><span class="s1">&quot;, mode=&quot;list&quot;, inpfile=</span><span class="si">{1}</span><span class="s1">, flagbackup=False)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">(),</span> <span class="n">casa_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">flag_cmd</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">flag_cmd</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of polarisation calibrator </span><span class="si">{}</span><span class="s2"> ... Done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of target </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
            <span class="c1"># create a casa-conform list</span>
            <span class="n">casa_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;antenna=&#39;</span><span class="si">{0}</span><span class="s2">&#39; correlation=&#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span><span class="p">]</span>
            <span class="n">flag_cmd</span> <span class="o">=</span> <span class="s1">&#39;flagdata(vis=&quot;</span><span class="si">{0}</span><span class="s1">&quot;, mode=&quot;list&quot;, inpfile=</span><span class="si">{1}</span><span class="s1">, flagbackup=False)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">(),</span> <span class="n">casa_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">flag_cmd</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">flag_cmd</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Flagging data of target </span><span class="si">{}</span><span class="s2"> ... Done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>

            <span class="c1"># add new flags to list of existing flags for this beam</span>
            <span class="n">ccal_flag_list</span> <span class="o">=</span> <span class="n">ccal_flag_list</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span>

        <span class="c1"># save entire flaglist</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_flag_list&#39;</span><span class="p">,</span> <span class="n">ccal_flag_list</span><span class="p">)</span>

        <span class="c1"># empty temporary flag list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crosscal_flag_list</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ccal.summary"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a general summary of the parameters in the parameter file generated during CROSSCAL. No detailed</span>
<span class="sd">        summary is available for CROSSCAL.</span>

<span class="sd">        returns (DataFrame): A python pandas dataframe object, which can be looked at with the style function in</span>
<span class="sd">        the notebook</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Load the parameters from the parameter file</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">FMOD</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">PMOD</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FIPH</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initial_phase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FGD</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FBP</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FG</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">PCD</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FL</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">PPA</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">FT</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">PT</span> <span class="o">=</span> <span class="n">subs_param</span><span class="o">.</span><span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">TT</span> <span class="o">=</span> <span class="n">get_param_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_transfer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create the data frame</span>

        <span class="n">beam_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span><span class="p">)</span>
        <span class="n">dataset_beams</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; Beam &#39;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beam_range</span><span class="p">]</span>
        <span class="n">dataset_indices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Flux calibrator (&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxcal</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Polarised calibrator (&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">polcal</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dataset_beams</span>

        <span class="n">all_MOD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_MOD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FMOD</span><span class="p">)</span>
        <span class="n">all_MOD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PMOD</span><span class="p">)</span>

        <span class="n">all_IPH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_IPH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FIPH</span><span class="p">)</span>

        <span class="n">all_GD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_GD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FGD</span><span class="p">)</span>

        <span class="n">all_BP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_BP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FBP</span><span class="p">)</span>

        <span class="n">all_G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_G</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FG</span><span class="p">)</span>

        <span class="n">all_CD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_CD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PCD</span><span class="p">)</span>

        <span class="n">all_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>

        <span class="n">all_PA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;   NA&#39;</span><span class="p">)</span>
        <span class="n">all_PA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PPA</span><span class="p">)</span>

        <span class="n">all_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NBEAMS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">all_T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FT</span>
        <span class="n">all_T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT</span>
        <span class="n">all_T</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">TT</span>

        <span class="n">df_mod</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_MOD</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span>
        <span class="n">df_iph</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_IPH</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Initial Phase&#39;</span><span class="p">])</span>
        <span class="n">df_gd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_GD</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Global Delay&#39;</span><span class="p">])</span>
        <span class="n">df_bp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_BP</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bandpass&#39;</span><span class="p">])</span>
        <span class="n">df_g</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_G</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Gains&#39;</span><span class="p">])</span>
        <span class="n">df_cd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_CD</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cross Hand Delay&#39;</span><span class="p">])</span>
        <span class="n">df_l</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_L</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Leakage&#39;</span><span class="p">])</span>
        <span class="n">df_pa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_PA</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Polarisation Angle&#39;</span><span class="p">])</span>
        <span class="n">df_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="n">all_T</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataset_indices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Transfer&#39;</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_mod</span><span class="p">,</span> <span class="n">df_iph</span><span class="p">,</span> <span class="n">df_gd</span><span class="p">,</span> <span class="n">df_bp</span><span class="p">,</span> <span class="n">df_g</span><span class="p">,</span>
                        <span class="n">df_cd</span><span class="p">,</span> <span class="n">df_l</span><span class="p">,</span> <span class="n">df_pa</span><span class="p">,</span> <span class="n">df_t</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="ccal.reset"><a class="viewcode-back" href="../../../modules/ccal.html#apercal.modules.ccal.ccal.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">do_clearcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_clearcal_fluxcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_clearcal_polcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_clearcal_target</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to reset the current step and clear all calibration from datasets as well as all calibration tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs_setinit</span><span class="o">.</span><span class="n">setinitdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">cbeam</span> <span class="o">=</span> <span class="s1">&#39;ccal_B&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                       <span class="s1">&#39;: Resetting flags and data values to before cross-calibration step&#39;</span><span class="p">)</span>
        <span class="c1"># Remove the calibration tables</span>
        <span class="c1"># for all beams and calibrators</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                                  <span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G0ph&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                                  <span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Bscan&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.G1ap&#39;</span><span class="p">,</span> <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.K&#39;</span><span class="p">,</span>
                                  <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Df&#39;</span><span class="p">,</span>
                                  <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                                  <span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Kcross&#39;</span><span class="p">,</span>
                                  <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subs_managefiles</span><span class="o">.</span><span class="n">director</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rm&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.MS&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.Xf&#39;</span><span class="p">,</span>
                                  <span class="n">ignore_nonexistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_clearcal</span> <span class="ow">or</span> <span class="n">do_clearcal_fluxcal</span><span class="p">:</span>
            <span class="c1"># Run a clearcal on the fluxcal and revert to the last flagversion</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Removing calibration from flux calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluxcal_path</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cc_dataset_clear</span> <span class="o">=</span> <span class="s1">&#39;clearcal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;)&#39;</span>
                <span class="n">cc_dataset_resetflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;restore&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">cc_dataset_removeflagtable</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;delete&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_dataset_clear</span><span class="p">,</span> <span class="n">cc_dataset_resetflags</span><span class="p">,</span>
                              <span class="n">cc_dataset_removeflagtable</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Calibration could not completely be removed from &#39;</span> <span class="o">+</span>
                             <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;. Flags might also not have been properly reset!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_clearcal</span> <span class="ow">or</span> <span class="n">do_clearcal_polcal</span><span class="p">:</span>
            <span class="c1"># Run a clearcal on the polcal and revert to the last flagversion</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Removing calibration from polarisation calibrator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polcal_path</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cc_dataset_clear</span> <span class="o">=</span> <span class="s1">&#39;clearcal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;)&#39;</span>
                <span class="n">cc_dataset_resetflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;restore&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">cc_dataset_removeflagtable</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;delete&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_dataset_clear</span><span class="p">,</span> <span class="n">cc_dataset_resetflags</span><span class="p">,</span>
                              <span class="n">cc_dataset_removeflagtable</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Calibration could not completely be removed from &#39;</span> <span class="o">+</span>
                             <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;. Flags might also not have been properly reset!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_clearcal</span> <span class="ow">or</span> <span class="n">do_clearcal_target</span><span class="p">:</span>
            <span class="c1"># Run a clearcal on the target and revert to the last flagversion</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Beam </span><span class="si">{}</span><span class="s2">: Removing calibration from target&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">))</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_path</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cc_dataset_clear</span> <span class="o">=</span> <span class="s1">&#39;clearcal(vis = &quot;&#39;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;)&#39;</span>
                <span class="n">cc_dataset_resetflags</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;restore&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">cc_dataset_removeflagtable</span> <span class="o">=</span> <span class="s1">&#39;flagmanager(vis = &quot;&#39;</span> <span class="o">+</span> \
                    <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;&quot;, mode = &quot;delete&quot;, versionname = &quot;ccal&quot;)&#39;</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">run_casa</span><span class="p">([</span><span class="n">cc_dataset_clear</span><span class="p">,</span> <span class="n">cc_dataset_resetflags</span><span class="p">,</span>
                              <span class="n">cc_dataset_removeflagtable</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span> <span class="s1">&#39;: Calibration could not completely be removed from &#39;</span> <span class="o">+</span>
                             <span class="n">dataset</span> <span class="o">+</span> <span class="s1">&#39;. Flags might also not have been properly reset!&#39;</span><span class="p">)</span>
        <span class="c1"># Remove the keywords in the parameter file</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Beam &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">+</span>
                       <span class="s1">&#39;: Deleting parameter file entries for CROSSCAL module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_clearcal_fluxcal</span><span class="p">:</span>
            <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_model&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_clearcal_polcal</span><span class="p">:</span>
            <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_model&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_initialphase&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_globaldelay&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_bandpass&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_apgains&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_crosshanddelay&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_leakage&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_polarisationangle&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_fluxcal_transfer&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_polcal_transfer&#39;</span><span class="p">)</span>
        <span class="n">subs_param</span><span class="o">.</span><span class="n">del_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbeam</span> <span class="o">+</span> <span class="s1">&#39;_targetbeams_transfer&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apercal 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Apercal Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>